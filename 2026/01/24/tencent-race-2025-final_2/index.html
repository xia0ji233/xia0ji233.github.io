<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>腾讯游戏安全竞赛2025复赛题解（加强版） | xia0ji233's blog</title><meta name="author" content="xia0ji233"><meta name="copyright" content="xia0ji233"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="由于去年很多分析的不到位的地方，故今年想详细分析一遍整体逻辑。">
<meta property="og:type" content="article">
<meta property="og:title" content="腾讯游戏安全竞赛2025复赛题解（加强版）">
<meta property="og:url" content="https://xia0ji233.github.io/2026/01/24/tencent-race-2025-final_2/index.html">
<meta property="og:site_name" content="xia0ji233&#39;s blog">
<meta property="og:description" content="由于去年很多分析的不到位的地方，故今年想详细分析一遍整体逻辑。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xia0ji233.github.io/img/avatar.png">
<meta property="article:published_time" content="2026-01-24T04:00:00.000Z">
<meta property="article:modified_time" content="2026-01-24T04:06:57.981Z">
<meta property="article:author" content="xia0ji233">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xia0ji233.github.io/img/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://xia0ji233.github.io/2026/01/24/tencent-race-2025-final_2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '腾讯游戏安全竞赛2025复赛题解（加强版）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2026-01-24 12:06:57'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="xia0ji233's blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">313</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">93</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heartbeat"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-history"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-bars"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/backgroud.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="xia0ji233's blog"><span class="site-name">xia0ji233's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heartbeat"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-history"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-bars"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">腾讯游戏安全竞赛2025复赛题解（加强版）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-24T04:00:00.000Z" title="发表于 2026-01-24 12:00:00">2026-01-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-24T04:06:57.981Z" title="更新于 2026-01-24 12:06:57">2026-01-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98/">比赛复盘</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98/%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B/">腾讯游戏安全竞赛</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="腾讯游戏安全竞赛2025复赛题解（加强版）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>由于去年很多分析的不到位的地方，故今年想详细分析一遍整体逻辑。</p>
<span id="more"></span>

<p>本篇帖子基于赛后复盘的角度去分析，相比之前发文会有更多详细且有理有据的逻辑分析，少很多暴力和猜测的结果（虽然一些部分还是需要靠猜），旨在真正学习其中的技术。</p>
<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><blockquote>
<p>（1）<strong>在intel CPU&#x2F;64位Windows10系统</strong>上运行sys，成功加载驱动（0.5分）</p>
<p>（2）能在双机环境运行驱动并调试（1分）</p>
<p>（3）优化驱动中的耗时算法，并给出demo能快速计算得出正确的key（1分）</p>
<p>（4）分析并给出flag的计算执行流程（1.5分），能准确说明其串联逻辑（0.5分）</p>
<p>（5）正确解出flag（1分）</p>
<p>（6）该题目使用了一种外挂常用的隐藏手段，请给出多种检测方法，要求demo程序能在题目驱动运行的环境下进行精确检测，方法越多分数越高（3分）</p>
<p>（7）文档编写，详细描述解题过程，详述提供的解题程序的演示方法。做到清晰易懂，操作可以复现结果；编码工整风格优雅、注释详尽（1.5分）</p>
</blockquote>
<h2 id="加载驱动"><a href="#加载驱动" class="headerlink" title="加载驱动"></a>加载驱动</h2><p>开双机调试，加载，驱动直接蓝屏，不要慌。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/1.png" class="">

<p>先 <code>.reload</code> 加载符号，再 <code>lm</code> 列出所有模块。如果 <code>NT</code> 的符号没有加载上 <code>lm</code> 是列不出所有模块的，因为列模块的行为需要依赖 <code>nt</code> 的 <code>pdb</code>。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/2.png" class="">

<p>然后直接 dump 蓝屏的加载好的驱动，IDA 打开之后发现连 <code>text</code> 段都没有被正确映射。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/3.png" class="">

<p>但是去查看对应的内存肯定有，原因是题目加了 vmp 壳，它破坏了 PE 头，导致 IDA 按照错误的 section 去映射了文件内容，因此我们需要修一下。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/4.png" class="">

<p>可以看到，<code>SizeOfRawData</code> 值被置为 <code>0</code> 了，当该值被置 <code>0</code> 时，PE 文件认为这个 section 没有映射任何文件内存，因此需要修复这个 dump。</p>
<p>修 dump 的手段很简单：令所有节区的 <code>section[i].PointerToRawData = section[i].VirtualAddress</code> 且 <code>section[i].SizeOfRawData = (section[i].Misc.VirtualSize + FileAlign - 1) &amp; ~(FileAlign - 1)</code></p>
<p>这里的 <code>FileAlgin</code> 是 PE 的一个字段，通常是 <code>0x200</code>，把它对齐即可。</p>
<p>这里给出一下我修复的代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FixDump</span><span class="params">(BYTE* base, DWORD fileSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fileSize &lt; <span class="built_in">sizeof</span>(IMAGE_DOS_HEADER))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] File too small\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IMAGE_DOS_HEADER* dos = (IMAGE_DOS_HEADER*)base;</span><br><span class="line">    <span class="keyword">if</span> (dos-&gt;e_magic != IMAGE_DOS_SIGNATURE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Invalid DOS signature\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IMAGE_NT_HEADERS64* nt =</span><br><span class="line">        (IMAGE_NT_HEADERS64*)(base + dos-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nt-&gt;Signature != IMAGE_NT_SIGNATURE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Invalid NT signature\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span>&amp; opt = nt-&gt;OptionalHeader;</span><br><span class="line">    IMAGE_SECTION_HEADER* sec = <span class="built_in">IMAGE_FIRST_SECTION</span>(nt);</span><br><span class="line"></span><br><span class="line">    UINT64 StartAddress = <span class="number">0x1000</span>;</span><br><span class="line">    DWORD FileAlign = opt.FileAlignment;</span><br><span class="line">    DWORD MemoryAlign = opt.SectionAlignment;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> name[<span class="number">9</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">memcpy</span>(name, sec[i].Name, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> ((sec[i].SizeOfRawData == <span class="number">0</span> || sec[i].PointerToRawData != sec[i].VirtualAddress) &amp;&amp; sec[i].Misc.VirtualSize != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] %-8s Section Corruption Detected or not DumpFile !!\n&quot;</span>, name);</span><br><span class="line">            sec[i].PointerToRawData = sec[i].VirtualAddress;</span><br><span class="line">            sec[i].SizeOfRawData = (sec[i].Misc.VirtualSize + FileAlign - <span class="number">1</span>) &amp; ~(FileAlign - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DWORD epFoa = <span class="built_in">RvaToFoa</span>(opt.AddressOfEntryPoint, nt);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nEntryPoint FOA : 0x%X\n&quot;</span>, epFoa);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epFoa == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] EntryPoint not mapped in file\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save </span></span><br><span class="line"></span><br><span class="line">    HANDLE hFile = <span class="built_in">CreateFileW</span>(</span><br><span class="line">        <span class="string">L&quot;fixed.dump&quot;</span>,</span><br><span class="line">        GENERIC_WRITE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">nullptr</span>,</span><br><span class="line">        CREATE_ALWAYS,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">nullptr</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to create output file\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD written = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteFile</span>(hFile, base, fileSize, &amp;written, <span class="literal">nullptr</span>) || written != fileSize)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to write output file\n&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Fixed dump saved to fixed.dump\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就修上了，ida 打开可以发现映射的内存和调试器中的内存是可以一一对应的。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/5.png" class="">

<p>下面需要去分析 dump，由于 PE 头被破坏，因此得到的入口点也是错误的，这里还是 Lumina 大法。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/6.png" class="">

<p>因为 WDF 框架的 Entry 基本都一致，所以不用记特征码，直接 lumina 识别肯定能识别出来。</p>
<p>找到 Entry 之后需要小修一下。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/7.png" class="">

<p>由于 VMP 的导入表保护，导致出现了一些小花指令，这里给出修的经验：如果熟悉，直接把可能的CALL API指令后一个字节 NOP，然后重新生成指令，就像下面一样。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/8.png" class="">

<p>假设你不熟悉，那么就要请本期的真神了，一把梭的利器 —— <code>unicorn</code>，直接对 API 模拟一遍就能发现指令序列。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/9.png" class="">

<p>模拟跑一遍就会发现几乎所有 API 调用之后都会放一个无用字节干扰反汇编器，所以熟悉了直接 NOP，不熟悉模拟一遍也能得到这个结论。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/10.png" class="">

<p>成功识别出 Entry。</p>
<p>再跟进去找到真实的逻辑</p>
<img src="/2026/01/24/tencent-race-2025-final_2/11.png" class="">

<p>然后还是开始模拟大法，这里就五个调用的函数，都模拟一遍给出结论：</p>
<p>第一个函数</p>
<img src="/2026/01/24/tencent-race-2025-final_2/12.png" class="">

<p>没有进行任何的 API 调用，只有一个 cpuid 指令引起了兴趣，再加上题目要求是 Intel CPU，基本可以断定是进行一定的环境判断。</p>
<p>第二个函数模拟了 10000 条指令都没结束，且没有遇到任何 API 调用，是被 vm 保护的关键逻辑，这里我们不去硬刚 vm，绕道而行，来看看第三个函数。</p>
<p>模拟第三个函数基本上就是一眼丁真</p>
<img src="/2026/01/24/tencent-race-2025-final_2/13.png" class="">

<p>这要还不能分析出怎么加载驱动那是真没招了。</p>
<p>那么第一问到这里就结束了，在驱动注册表目录下新建一个表项 <code>2025ACECTF</code>，里面建两个字段，一个是 <code>Flag</code> 一个是 <code>Key</code>，有了这些表项，驱动就能直接加载成功（不加调试器）。</p>
<h2 id="调试驱动"><a href="#调试驱动" class="headerlink" title="调试驱动"></a>调试驱动</h2><p>要做到调试驱动，就需要过反调，需要明白它具体反调的措施在哪里。经过调试可以发现刚没有分析出的第二个函数就是反调试的主要逻辑，这一块被 vm 了怎么办呢？抽丝剥茧找线索，第一搜索蓝屏代码，0x414345。</p>
<p>可以找到两个位置出现了这样的字节序列</p>
<img src="/2026/01/24/tencent-race-2025-final_2/14.png" class="">

<p>其中 <code>0x16C4</code> 的逻辑就是清栈加调用蓝屏函数。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/15.png" class="">

<p>交叉引用找不下去了，这个时候需要注意到另一个函数，也就是 <code>0x74F0</code>。基本上，它把一切东西设置成跟自身相关的，都是在引导我们去看的。就比如这里蓝屏代码的 <code>0x414345</code>，如果它不想我们找到，理论上可以设置成一个正常的蓝屏代码干扰我们分析，所以我们去分析另一个跟 <code>ACE</code> 相关的 <code>magic number</code>。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/16.png" class="">

<p>这里打印了一句话，懒得写模拟执行了，直接用 defs 的宏复制解密代码就行。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> enc[]=&#123;</span><br><span class="line">	<span class="number">0x39</span>, <span class="number">0xF8</span>, <span class="number">0x92</span>, <span class="number">0xBD</span>, <span class="number">0x67</span>, <span class="number">0xE4</span>, <span class="number">0xDF</span>, <span class="number">0xDC</span>, <span class="number">0x75</span>, <span class="number">0xFF</span>, </span><br><span class="line">	<span class="number">0x9C</span>, <span class="number">0x95</span>, <span class="number">0x6F</span>, <span class="number">0xEB</span>, <span class="number">0xD3</span>, <span class="number">0x08</span>, <span class="number">0x49</span>, <span class="number">0xE0</span>, <span class="number">0x9B</span>, <span class="number">0x80</span>,</span><br><span class="line">	<span class="number">0x53</span>, <span class="number">0xE9</span>, <span class="number">0x93</span>, <span class="number">0x8B</span>, <span class="number">0xF0</span> </span><br><span class="line">&#125;; </span><br><span class="line"><span class="function">_BYTE *__fastcall <span class="title">sub_FFFFF8080AFC79C8</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp+8h]</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">0x19</span>; ++i )</span><br><span class="line">		a1[i] ^= <span class="number">0</span>;</span><br><span class="line">	a1[<span class="number">24</span>] += <span class="number">16</span>;</span><br><span class="line">	a1[<span class="number">23</span>] = __ROL1__(a1[<span class="number">23</span>], <span class="number">2</span>);</span><br><span class="line">	a1[<span class="number">22</span>] = ~a1[<span class="number">22</span>];</span><br><span class="line">	a1[<span class="number">21</span>] ^= <span class="number">0x80u</span>;</span><br><span class="line">	a1[<span class="number">20</span>] += <span class="number">28</span>;</span><br><span class="line">	a1[<span class="number">19</span>] = __ROL1__(a1[<span class="number">19</span>], <span class="number">6</span>);</span><br><span class="line">	a1[<span class="number">18</span>] = ~a1[<span class="number">18</span>];</span><br><span class="line">	a1[<span class="number">17</span>] ^= <span class="number">0x84u</span>;</span><br><span class="line">	a1[<span class="number">16</span>] += <span class="number">24</span>;</span><br><span class="line">	a1[<span class="number">15</span>] = __ROL1__(a1[<span class="number">15</span>], <span class="number">2</span>);</span><br><span class="line">	a1[<span class="number">14</span>] = ~a1[<span class="number">14</span>];</span><br><span class="line">	a1[<span class="number">13</span>] ^= <span class="number">0x98u</span>;</span><br><span class="line">	a1[<span class="number">12</span>] += <span class="number">4</span>;</span><br><span class="line">	a1[<span class="number">11</span>] = __ROL1__(a1[<span class="number">11</span>], <span class="number">6</span>);</span><br><span class="line">	a1[<span class="number">10</span>] = ~a1[<span class="number">10</span>];</span><br><span class="line">	a1[<span class="number">9</span>] ^= <span class="number">0x9Cu</span>;</span><br><span class="line">	a1[<span class="number">7</span>] = __ROL1__(a1[<span class="number">7</span>], <span class="number">2</span>);</span><br><span class="line">	a1[<span class="number">6</span>] = ~a1[<span class="number">6</span>];</span><br><span class="line">	a1[<span class="number">5</span>] ^= <span class="number">0x90u</span>;</span><br><span class="line">	a1[<span class="number">4</span>] += <span class="number">12</span>;</span><br><span class="line">	a1[<span class="number">3</span>] = __ROL1__(a1[<span class="number">3</span>], <span class="number">6</span>);</span><br><span class="line">	a1[<span class="number">2</span>] = ~a1[<span class="number">2</span>];</span><br><span class="line">	a1[<span class="number">1</span>] ^= <span class="number">0x94u</span>;</span><br><span class="line">	*a1 += <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">sub_FFFFF8080AFC79C8</span>(enc);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, enc); </span><br><span class="line">	<span class="comment">// Almost success, add oil.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>defs.h</code> 的定义 ida 里面有，直接找就行。然后果然输出了一句话，告诉我们几乎成功了，加油。。</p>
<p>作为出题人，能给我们这么多提示已经很够意思了，那么我们开始去调这个函数，写一个 hook 框架，这里抄网上开源的就行。总的来说就是注册回调，加载内核模块的时候匹配 <code>ACE</code> 进行拦截操作。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">LoadImageNotifyRoutine</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PUNICODE_STRING FullImageName,</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE ProcessId,</span></span></span><br><span class="line"><span class="params"><span class="function">    PIMAGE_INFO ImageInfo</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ProcessId &amp;&amp; FullImageName &amp;&amp; <span class="built_in">wcsstr</span>(FullImageName-&gt;Buffer, <span class="string">L&quot;ACE&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DBG_PRINT</span>(<span class="string">&quot;\n&gt; ============= Driver %ws ================\n&quot;</span>, FullImageName-&gt;Buffer);</span><br><span class="line">        Hooks::Base = ImageInfo-&gt;ImageBase;</span><br><span class="line">        Hooks::Size = ImageInfo-&gt;ImageSize;</span><br><span class="line">        <span class="built_in">DBG_PRINT</span>(<span class="string">&quot;ImageBase: 0x%p\n&quot;</span>, (UINT64)ImageInfo-&gt;ImageBase);</span><br><span class="line">        <span class="built_in">DBG_PRINT</span>(<span class="string">&quot;Breakpoint: 0x%p\n&quot;</span>, (UINT64)ImageInfo-&gt;ImageBase + <span class="number">0x74f0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>断点可以断到，但是由于开头的 vm 导致后续 RIP 落点不确定，因此从头开始调试不太现实，但是模拟执行输出那句话的时候还是发现了蛛丝马迹。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/17.png" class="">

<p>可以发现它一直在死循环输出这句话，从这里就可以得到一个结论了：它肯定创建了线程去反调试的。</p>
<p>当然在它分配内存的时候，还是看到了几个函数调用，由于模拟执行不能完全仿真上下文，所以还是跑调试器里面去查会比较好。</p>
<p>直接断开头的 ExAllocateWithTag 就行，然后断第一个 call，一眼盯真了。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/18.png" class="">

<p>那么直接在第二个 <code>call</code> 下断，不出意外的话应该是插入 DPC 的 API 了。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/19.png" class="">

<p>没问题，太完美了。 DPC 例程在 <code>+0x78c0</code>，<code>context</code> 就的内容直接指向 KeBugCheckEx 函数，但是为什么交叉引用没有找到函数呢？</p>
<img src="/2026/01/24/tencent-race-2025-final_2/20.png" class="">

<p>很棒，原来蓝屏之后还把调用入口给放了个 <code>C3</code> 导致反编译没成功。。</p>
<p>这个蓝屏方式有点似曾相识，遥想当年 hook 蓝屏延时一年的操作，当时看出题人发的文章说，该用 DPC 的方式去蓝屏的，没想到第二年的题真就做了。</p>
<p>蓝屏之后的代码就是无限循环输出 <code>You Found This</code>。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/21.png" class="">

<p>是的，unicorn 上大分，只要能模拟，绝对不调试。。</p>
<p>这就解释了为什么它防住了我 hook 蓝屏的方法，直接 hook KeBugCheckEx 肯定不行，因为它清栈了，但是我把它清栈的函数 hook 了 ret 呢？也不行，因为hook了这里后面的代码就直接死循环，DPC 死循环，系统直接卡死，所以直接给 <code>16C4</code>  <code>ret</code> 的后果就是卡死系统，不会蓝屏，但是系统也不会有响应，调试器也不会断开，可以正常中断。</p>
<p>如果让 DPC 例程直接 <code>ret</code> 会怎么样呢，还是直接蓝屏，蓝屏代码 50。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">KDTARGET: Refreshing KD connection</span><br><span class="line"></span><br><span class="line">*** Fatal System Error: 0x00000050</span><br><span class="line">                       (0xFFFFF80743600000,0x0000000000000003,0xFFFFF8085CC81230,0x0000000000000002)</span><br><span class="line"></span><br><span class="line">Driver at fault: </span><br><span class="line">***  ACEDriver.sys - Address FFFFF8085CC81230 base at FFFFF8085C520000, DateStamp 67f67836</span><br><span class="line">.</span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line"></span><br><span class="line">A fatal system error has occurred.</span><br><span class="line">Debugger entered on first try; Bugcheck callbacks have not been invoked.</span><br><span class="line"></span><br><span class="line">A fatal system error has occurred.</span><br><span class="line"></span><br><span class="line">For analysis of this file, run !analyze -v</span><br></pre></td></tr></table></figure>

<p>这里要研究原因估计得更深入的知识了，但是我们都已经清楚了它的调用逻辑了，为什么不直接阻止它插入 DPC 呢？</p>
<p>初始化，插入，交付，这三个执行完了之后还会执行一个清零内存操作，经过调试发现是 nt 模块，而且长度为 <code>0x1046000</code>，这个数值有点大了。。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/22.png" class="">

<p>然后继续运行，发现 nt 的内存一旦被写就直接蓝屏了，蓝屏代码就是我们刚刚看到的那样，看起来刚刚的蓝屏与DPC无关。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/23.png" class="">

<p>那么就清晰了，还需要把这里写 nt 的逻辑跳过去才能往后，直接写个 jmp 过去就行。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/24.png" class="">

<p>好，继续，进入死循环，但是系统依然卡死，只能动一点点。这里逻辑发现挖不下去了，因此最后选择去把 <code>+0x74f0</code> 的函数 <code>ret</code> 掉。虽然结论与前面一致，但是完整地分析了整个流程。</p>
<p>最后就是耳熟能详的，<code>KdDisableDebugger</code> 这个 <code>API</code>。完成调试要求，要么干检测，要么干反调试。</p>
<p>这里选择干反调试，一个是防起线程，一个就是内核 API，通常也就是这个 <code>KdDisableDebugger</code>，这两个干掉之后，题目就可以正常调试了，也能正常加载。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/25.png" class="">

<p>下面给出关键代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">gh_KeSetSystemAffinityThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    KAFFINITY Affinity</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">KeSetSystemAffinityThread</span>(Affinity);</span><br><span class="line">    <span class="type">char</span> code = <span class="number">0xC3</span>; <span class="comment">// ret</span></span><br><span class="line">    DriverUtil::<span class="built_in">MDLWriteMemory</span>((PVOID)((UINT64)Hooks::Base + <span class="number">0x74f0</span>), &amp;code, <span class="number">1</span>);</span><br><span class="line">    UNICODE_STRING KdDisableDebuggerStr = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;KdDisableDebugger&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> KdDisableDebugger = <span class="built_in">MmGetSystemRoutineAddress</span>(&amp;KdDisableDebuggerStr);</span><br><span class="line">    DriverUtil::<span class="built_in">MDLWriteMemory</span>((PVOID)(KdDisableDebugger), &amp;code, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">LoadImageNotifyRoutine</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PUNICODE_STRING FullImageName,</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE ProcessId,</span></span></span><br><span class="line"><span class="params"><span class="function">    PIMAGE_INFO ImageInfo</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ProcessId &amp;&amp; FullImageName &amp;&amp; <span class="built_in">wcsstr</span>(FullImageName-&gt;Buffer, <span class="string">L&quot;ACE&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DBG_PRINT</span>(<span class="string">&quot;\n&gt; ============= Driver %ws ================\n&quot;</span>, FullImageName-&gt;Buffer);</span><br><span class="line">        HANDLE hThread;</span><br><span class="line">        Hooks::Base = ImageInfo-&gt;ImageBase;</span><br><span class="line">        Hooks::Size = ImageInfo-&gt;ImageSize;</span><br><span class="line">        DriverUtil::<span class="built_in">IATHook</span>(Hooks::Base, <span class="string">&quot;KeSetSystemAffinityThread&quot;</span>, (PVOID)gh_KeSetSystemAffinityThread);</span><br><span class="line">        <span class="built_in">DBG_PRINT</span>(<span class="string">&quot;ImageBase: 0x%p\n&quot;</span>, (UINT64)ImageInfo-&gt;ImageBase);</span><br><span class="line">        <span class="built_in">DBG_PRINT</span>(<span class="string">&quot;Breakpoint1: 0x%p\n&quot;</span>, (UINT64)ImageInfo-&gt;ImageBase + <span class="number">0x74f0</span>);</span><br><span class="line">        <span class="built_in">DBG_PRINT</span>(<span class="string">&quot;Breakpoint2: 0x%p\n&quot;</span>, (UINT64)ImageInfo-&gt;ImageBase + <span class="number">0x761190</span>);</span><br><span class="line">        <span class="comment">// DbgBreakPoint();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给 <code>KeSetSystemAffinityThread</code> 作 <code>IATHook</code>，因为调用到这个 API 通常意味着 Vmp 解密代码已经完成，这个时机对代码做 inline hook 是最好的。</p>
<h2 id="优化算法"><a href="#优化算法" class="headerlink" title="优化算法"></a>优化算法</h2><p>如果 IDA 反编译的时候出现了这样的情况</p>
<img src="/2026/01/24/tencent-race-2025-final_2/26.png" class="">

<p>通常是调用的函数被声明为 <code>noreturn</code>，直接到该函数修改属性即可。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/27.png" class="">

<p>调试问题解决了，不难推出，下面的代码</p>
<img src="/2026/01/24/tencent-race-2025-final_2/28.png" class="">

<p>通过一个函数把 <code>flag</code>，<code>key</code> 和 <code>flag</code> 的长度都读取到了全局变量中再进行判断。</p>
<p>还是那句话，遇事不决，模拟就完了。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/29.png" class="">

<p>如果 Key 给了 0，则调用算法生成，那么主要逆的就是这个函数了。函数里面告诉了你一句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This step will take a long time to run, maybe 12 hours (depending on your machine), maybe you have a better way?</span><br></pre></td></tr></table></figure>

<p>稍微往下翻你还会翻到一个字符串，紧挨着的，<code>deque&lt;T&gt; too long</code>。</p>
<p>对于这个函数，我们先来如梦令一下，令 <code>x=a1</code>，<code>y=a2</code>。</p>
<p>对第一个遇到的函数分析，模拟一遍发现类似 <code>new</code> 关键字分配了内存，然后来到第二个函数里面。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/30.png" class="">

<p>第二个参数指向的内存的前 8 个字节是 <code>x</code> 和 <code>y</code>，那么猜测这个数据结构应该是 32 字节的，还有剩下的 <code>24</code> 字节被置 0 了。</p>
<p>先预设一个结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">data</span>&#123;</span><br><span class="line">	<span class="type">int</span> x;</span><br><span class="line">	<span class="type">int</span> y;</span><br><span class="line">	<span class="type">char</span> pad[<span class="number">24</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后敏锐地发现了，a1[1] 指向的内存在存放 <code>data</code> 类型的指针。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/31.png" class="">

<p>不难得到这是一个 40 大小的结构体，其中 +8 指向一个指针数组，+32 指向了数量（因为最后的 <code>++a[4]</code>），先用下面的结构体试试看</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">data2</span></span><br><span class="line">&#123;</span><br><span class="line">    PVOID unknown;</span><br><span class="line">    data **arr;</span><br><span class="line">    PVOID unknown2;</span><br><span class="line">    PVOID unknown3;</span><br><span class="line">    <span class="type">size_t</span> mysize;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到结果</p>
<img src="/2026/01/24/tencent-race-2025-final_2/32.png" class="">

<p>一目了然，这是一个类似 <code>vector</code> 的 <code>push_back</code> 操作（当然你看到了字符串就直接知道是 deque 了）。</p>
<p><code>deque</code> 的内部实现用了一个环形队列，环形队列通常有取余的操作，为了优化，它的 <code>MaxSize</code> 通常是 <code>2</code> 的整数倍次方，因为如果这样的话取余的操作可以化简成 <code>&amp;(MaxSize - 1)</code>，也就是我们代码看到的样子。</p>
<p>最终的结构体变成：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">data2</span></span><br><span class="line">&#123;</span><br><span class="line">    PVOID unknown;</span><br><span class="line">    data **arr;</span><br><span class="line">    <span class="type">size_t</span> MaxSize;</span><br><span class="line">    <span class="type">size_t</span> begin;</span><br><span class="line">    <span class="type">size_t</span> mysize;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果对 <code>C++</code> 熟悉的同学可以知道 +0 的位置就是虚表，识别不出来也没关系，这个字段用不到。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/33.png" class="">

<p>配合上注释之后，一目了然，里面修好之后，外面也是一篇天地。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/34.png" class="">

<p>这里还有一点强调的就是，<code>begin</code> 是它指向数组的起始位置的下标，<code>mysize</code> 是队列中元素的个数，<code>(begin + Mysize -1) % MaxSize</code> 就是末尾元素的下标。</p>
<p>显然，<code>pad[16]</code> 的地方是一个 <code>flag</code> 标志位字段，<code>pad</code> 的地方存放了 <code>v5</code>，<code>v5</code> 是这个函数运算的结果。</p>
<p>所以可以解出整个结构体：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">unsigned</span> __int64 value;</span><br><span class="line">    <span class="type">unsigned</span> __int64 acc;</span><br><span class="line">    <span class="type">unsigned</span> __int32 flag;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改上之后，整个函数就非常清楚了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( x )</span><br><span class="line">&#123;</span><br><span class="line">    v<span class="number">21.</span>x = x;</span><br><span class="line">    v<span class="number">21.</span>y = y;</span><br><span class="line">LABEL_4:</span><br><span class="line">    <span class="built_in">memset</span>(&amp;v<span class="number">21.</span>value, <span class="number">0</span>, <span class="number">20</span>);</span><br><span class="line">    deque::<span class="built_in">push_back</span>(&amp;v20, &amp;v21);</span><br><span class="line">    mysize = v<span class="number">20.</span>mysize;</span><br><span class="line">    <span class="keyword">while</span> ( mysize )</span><br><span class="line">    &#123;</span><br><span class="line">        v7 = v<span class="number">20.</span>arr[(v<span class="number">20.</span>MaxSize - <span class="number">1</span>) &amp; (mysize + v<span class="number">20.</span>begin - <span class="number">1</span>)];</span><br><span class="line">        py = v7-&gt;y;</span><br><span class="line">        <span class="keyword">if</span> ( !py || (px = v7-&gt;x, py == v7-&gt;x) )</span><br><span class="line">        &#123;</span><br><span class="line">            v5 = <span class="number">1</span>;</span><br><span class="line">            v<span class="number">20.</span>mysize = --mysize;</span><br><span class="line">            v<span class="number">20.</span>begin &amp;= -(__int64)(mysize != <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            flag = v7-&gt;flag;</span><br><span class="line">            <span class="keyword">if</span> ( !flag )	<span class="comment">// flag == 0</span></span><br><span class="line">            &#123;</span><br><span class="line">                v7-&gt;flag = <span class="number">1</span>;</span><br><span class="line">                v<span class="number">21.</span>x = px - <span class="number">1</span>;</span><br><span class="line">                v<span class="number">21.</span>y = py;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">            &#125;</span><br><span class="line">            v11 = flag - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ( !v11 )		<span class="comment">// flag == 1</span></span><br><span class="line">            &#123;</span><br><span class="line">                v7-&gt;value = v5;</span><br><span class="line">                v7-&gt;flag = <span class="number">2</span>;</span><br><span class="line">                v<span class="number">21.</span>x = px - <span class="number">1</span>;</span><br><span class="line">                v<span class="number">21.</span>y = py - <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v11 == <span class="number">1</span> )	 <span class="comment">// flag == 2</span></span><br><span class="line">            &#123;</span><br><span class="line">                v7-&gt;acc = v5;	<span class="comment">// unused</span></span><br><span class="line">                v5 += v7-&gt;value + px % <span class="number">5</span>;</span><br><span class="line">                mysize = --v<span class="number">20.</span>mysize;</span><br><span class="line">                <span class="keyword">if</span> ( !v<span class="number">20.</span>mysize )</span><br><span class="line">                    v<span class="number">20.</span>begin = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数，如果你想借助 AI 的力量，这个直接扔给它就能用了，如果你不想借助 AI 的力量，那么继续往下分析。</p>
<p>当 <code>flag == 0</code> 时：会令 <code>newdata.x = x - 1</code>，<code>newdata.y = y</code>，其它字段清空，并压入 deque 中 （注意，此时原来的元素并未弹出，而是将元素的 <code>flag</code> 置为 1）。</p>
<p>当 <code>flag == 1</code> 时：会令 <code>newdata.x = x - 1</code>，<code>newdata.y = y - 1</code>，其它字段清空，并压入 deque 中 （同理可得）。</p>
<p>当 <code>flag == 2</code> 时：累加前两个状态计算的值，并额外加上 <code>x % 5</code> 的值。</p>
<p>写成递归形式也不难：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">(x, y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == y || y == <span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">f</span>(x - <span class="number">1</span>, y) + <span class="built_in">f</span>(x - <span class="number">1</span>, y - <span class="number">1</span>) + x % <span class="number">5</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时间复杂度就是指数级的了，事实上，这个可以用动态规划优化到二次方的复杂度。</p>
<p>但是动态规划太难了怎么办，记忆化搜索即可，对于确定的 <code>x, y</code>，如果已经计算了值，那么直接返回这个值即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="type">long</span> ff[<span class="number">54</span>][<span class="number">54</span>];</span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">f</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (y == <span class="number">0</span> || x == y) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (ff[x][y] != <span class="number">0</span>) <span class="keyword">return</span> ff[x][y];</span><br><span class="line">    <span class="keyword">return</span> ff[x][y] = <span class="built_in">f</span>(x - <span class="number">1</span>, y) + <span class="built_in">f</span>(x - <span class="number">1</span>, y - <span class="number">1</span>) + (x % <span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// f(44, 22) == 0x66711265fd2</span></span><br></pre></td></tr></table></figure>

<p>谁人不晓 “十年OI一场空，不开 long long 见祖宗”，要没开 <code>long long</code> 你就调吧，一调一个不吱声。</p>
<p>要是还是不确定怎么办？答：模拟执行。</p>
<p>这个函数只要把 <code>ExAllocatePoolWithTag</code> 函数实现了，随便模拟，在函数开始的时候设置上下文，<code>RCX = x, RDX = y</code> 即可，函数返回的时候把 <code>RAX</code> 输出。</p>
<p>以 <code>10, 5</code> 为例，我的算法跑出来是 <code>0x356</code>。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/35.png" class="">

<p>那么来观察模拟执行的结果。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/36.png" class="">

<p>这就完美了，优化算法这一问到这里也是满分了。</p>
<h2 id="说明Flag的计算流程"><a href="#说明Flag的计算流程" class="headerlink" title="说明Flag的计算流程"></a>说明Flag的计算流程</h2><p>这一关最难的是 VT 的分析，但是，如果你有强大的 lumina，那么识别这个库就是轻而易举。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/37.png" class="">

<p>lumina 可以快速识别出这是 <code>hv</code> 的库编译的，如果还没用上 lumina，可以使用我搭建的服务器</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://8.153.71.247:8000/lumina/info.html">http://8.153.71.247:8000/lumina/info.html</a></li>
</ul>
<p>剩余的可能需要对源码进行调试，当然还是先看看外面的逻辑。</p>
<p>第一步就是简单的用 Key 转成字符串之后进行异或加密</p>
<img src="/2026/01/24/tencent-race-2025-final_2/38.png" class="">

<p>但是实际调试的时候发现并不是这样，调试器来到这里，观察一个神奇的 <code>mov</code> 指令。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/39.png" class="">

<p>惊不惊喜，意不意外？是不是瞬间感觉自己见到了假的 <code>mov</code> 指令，这个时候是不是不甘心认为输出的是十六进制，就算是十六进制偶数不可能变奇数的（狗头。</p>
<p>实则不要慌，当年我半夜从一点按调试器按到四点一个一个按完了才出来的 flag。这个地方必然被 VT 下了 hook，篡改了这个寄存器的值，首先找到 vmlauch 指令，交叉引用来到加载的地方。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/40.png" class="">

<p>看不懂没关系，根据这个 <code>rdmsr</code> 指令搜 <code>486</code>。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/41.png" class="">

<p>然后就可以恢复这个结构体，这里浇一点小技巧，为了导入 hv 的结构体，可以直接加载 hv 的 pdb，选择只加载结构即可。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/42.png" class="">

<p>加载完成之后，根据这个偏移，就能大概恢复一下它自己的结构体。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">VCPUContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> s[<span class="number">2572384</span>];</span><br><span class="line">    hv::vcpu_cached_data cache;</span><br><span class="line">    guest_context *context;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> queued_nmis;</span><br><span class="line">    <span class="type">unsigned</span> __int64 tsc_offset;</span><br><span class="line">    <span class="type">unsigned</span> __int64 preemption_timer;</span><br><span class="line">    <span class="type">unsigned</span> __int64 vm_exit_tsc_overhead;</span><br><span class="line">    <span class="type">unsigned</span> __int64 vm_exit_mperf_overhead;</span><br><span class="line">    <span class="type">unsigned</span> __int64 vm_exit_ref_tsc_overhead;</span><br><span class="line">    <span class="type">char</span> pad[<span class="number">3856</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后再看看</p>
<img src="/2026/01/24/tencent-race-2025-final_2/43.png" class="">

<p>对应上了，主要的分发逻辑，需要在 <code>vm_exit</code> 中看，<code>vm_exit</code> 就是在 <code>guest</code> 触发需要 <code>host</code> 接管时由 <code>host</code> 处理的代码，这种页面的替换通常是下了 EPT hook，</p>
<p>先在项目里找到各种的 <code>vm_exit</code> 代码，这个代码是 <code>Intel</code> 规定的，是改不了的。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/44.png" class="">

<p>EPT 的页的访问违例的代码是 0x30。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/45.png" class="">

<p><code>vmread r1, 0x4402</code>  可以将 <code>VM_EXIT_REASON</code> 读取到 <code>r1</code> 寄存器中。</p>
<p>知道这些之后，就可以看懂 <code>vm_exit</code> 中的主要处理函数了，<code>vm_exit</code> 这个函数是可以被 lumina 识别到的，你甚至不需要特意去寻找，如图绿色底的函数就是 lumina 识别到的。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/46.png" class="">

<p>可以看到，读取 <code>VM_EXIT_REASON</code> 到寄存器 <code>RCX</code> 之后进行了一定的加密，加密方法是：<code>(reason &lt;&lt; 8 | 0x58) ^ 0x7655</code>，那么 0x30 对应的加密结果就是  0x460D。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/47.png" class="">

<p>进入函数可以看到关键点：</p>
<img src="/2026/01/24/tencent-race-2025-final_2/48.png" class="">

<p>这里读取了 GUEST 的 RIP 然后进行硬编码判断，硬编码结果为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">41 8A 04 0F 88 45 A0 49</span><br></pre></td></tr></table></figure>

<p>刚好对应读取的指令</p>
<img src="/2026/01/24/tencent-race-2025-final_2/49.png" class="">

<p>随后读取了 GUEST 的寄存器，找到了 <code>r15+rcx</code> 指向的内存（<code>flag</code> 字符），并且提取了 r8 寄存器的值，回到原来加密地方的上下文不难看出这个 r8 就是读取的下标。</p>
<p>随后将 <code>flag</code> 字符和下标变量放入一个函数进行加密替换，想要验证怎么办，那还是模拟执行，把刚刚 mov 第一条指令的结果输入进去，第一个参数给 <code>0x66</code>，第二个参数给 <code>0</code>。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/50.png" class="">

<p>这就完美了，跟刚刚调试器看到的结果是一致的，这里给一个不吃操作也不吃经济的打法，直接复制出来，引用 defs.h 即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> __fastcall <span class="title">sub_FFFFF8080AFC300C</span><span class="params">(<span class="type">char</span> a1, <span class="type">char</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> v2; <span class="comment">// r10</span></span><br><span class="line">    <span class="type">bool</span> v3; <span class="comment">// zf</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 v4; <span class="comment">// r11</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 v5; <span class="comment">// dl</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 v6; <span class="comment">// cl</span></span><br><span class="line">    __int64 v7; <span class="comment">// rbx</span></span><br><span class="line">    __int64 v8; <span class="comment">// rcx</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// edi</span></span><br><span class="line">    <span class="type">char</span> v10; <span class="comment">// r9</span></span><br><span class="line">    __int64 v11; <span class="comment">// rdx</span></span><br><span class="line">    <span class="type">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">    _BYTE *v13; <span class="comment">// r8</span></span><br><span class="line">    <span class="type">char</span> v14; <span class="comment">// dl</span></span><br><span class="line">    <span class="type">char</span> v15; <span class="comment">// dl</span></span><br><span class="line">    _DWORD v17[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    v4 = a2 ^ a1;</span><br><span class="line">    v3 = a2 == a1;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            v5 += v6 &amp; <span class="number">1</span>;</span><br><span class="line">            v6 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v6 );</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = <span class="number">7</span>;</span><br><span class="line">    v8 = v5;</span><br><span class="line">    v17[<span class="number">0</span>] = <span class="number">50462976</span>;</span><br><span class="line">    v17[<span class="number">1</span>] = <span class="number">117835012</span>;</span><br><span class="line">    v9 = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v10 = *((_BYTE *)v17 + v7);</span><br><span class="line">        v8 = <span class="number">0x3F5713FCCC7C79AALL</span> * v8 + <span class="number">0x3A7D9E5B36F498B2LL</span>;</span><br><span class="line">        v11 = <span class="built_in">HIDWORD</span>(v8) % v9--;</span><br><span class="line">        *((_BYTE *)v17 + v7--) = *((_BYTE *)v17 + v11);</span><br><span class="line">        *((_BYTE *)v17 + v11) = v10;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v7 &gt; <span class="number">0</span> );</span><br><span class="line">    v12 = <span class="number">0</span>;</span><br><span class="line">    v13 = v17;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v14 = v4 &gt;&gt; *v13++;</span><br><span class="line">        v15 = (v14 &amp; <span class="number">1</span>) &lt;&lt; v12++;</span><br><span class="line">        v2 |= v15;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v12 &lt; <span class="number">8</span> );</span><br><span class="line">    <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反正单字节加密直接爆破就行，随后跟到校验的逻辑里面，发现了保留的 TEA 加密：</p>
<img src="/2026/01/24/tencent-race-2025-final_2/51.png" class="">

<p>但是这个 TEA 是有乘法的，显然不可逆，还是猜想它做了 EPT hook，这里吃点操作了，我们想要找到被替换的原页是几乎不可能的，因为外部的 windbg 是通过 kdcom.dll 去通信的，当开启 VT 之后，kdcom.dll 是跑在 GUEST 层的，我们想从 GUEST 层去读 HOST 的代码在设计上就不可能，所以我们需要考虑在 hook 的时候找到被替换的页。 </p>
<p>幸运的是，这个是可行的，因为翻看 hv 的代码：</p>
<img src="/2026/01/24/tencent-race-2025-final_2/52.png" class="">

<p>它安装 hook 的行为是通过 guest 调用 vmcall 去实现的，vmcall 是跑在 guest 层的，我们可以中断到，但是这个 input 的 code 是 hv 库自定义的，所以不好说它的值有没有被修改。</p>
<p>找到处理 vmcall 的 <code>exit_reason</code>，代码是 0x12，计算得到加密的 reason 是 <code>0x640D</code>，回到 <code>vm_exit</code> 的分发找到对应的处理例程。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/53.png" class="">

<p>明显它需要让 <code>(RAX &gt;&gt; 8) ==0xE56C</code>，然后低八位表示了 vmcall 的调用号。</p>
<p>找到对应的源码：</p>
<img src="/2026/01/24/tencent-race-2025-final_2/54.png" class="">

<p>我们前面也提到过，这个数值是 hv 自己定义的，出题人拿到这个代码很容易改，但是有些东西只要是 Intel 的 CPU，它的代码就是固定的，谁来了都改不了（例如前面的这些宏），所以我们不一定找 8 对应的例程，还是要稍微翻一下。</p>
<p>这里也很简单，我们直接找 HOST 对应处理的例程。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/55.png" class="">

<p>很快就能找到与之相似的调用例程，枚举值被改成了 5。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/56.png" class="">

<p>所以我们重新加载驱动，去断 vmcall 指令，这个指令可以找 parttern 或者还是用 lumina 秒，找到指令位于 <code>+0x1557</code>。</p>
<p>发现第一次断住就是在下 ept hook 了。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/57.png" class="">

<p>那么就找 rcx 和 rdx 的值了，RCX 指向原页，RDX 指向目标页，那么把目标页 dump 下来。</p>
<p>+0x560 的地址找到目标的 TEA 加密函数</p>
<img src="/2026/01/24/tencent-race-2025-final_2/58.png" class="">

<p>这个 TEA 加密就是可逆的了，相信在座的各位在这时候已经可以随便秒了。</p>
<p>似乎之后没有什么逻辑了，就剩一个 flag 的校验</p>
<img src="/2026/01/24/tencent-race-2025-final_2/59.png" class="">

<p>但是走到 <code>rdmsr(0xE8)</code> 之后发现 flag 被修改了，那么去找对应的 rdmsr 的 <code>exit_reason = 0x0000001F</code>，加密的结果为 <code>0x690D</code>，找到关键位置。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/60.png" class="">

<p>它根据 flag 的长度对 flag 再次进行异或加密，并且除了调用 <code>rdmsr(0xE8)</code> 之外，还要 <code>[rsp+0x20] == 0x32A48680</code> 才会执行加密，那么调试跟过来看看，因为程序调用了两次 <code>rdmsr(0xE8)</code>。</p>
<p>第一次 rdmsr 的时候是不符合要求的。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/61.png" class="">

<p>第二次 rdmsr 的时候，符合要求</p>
<img src="/2026/01/24/tencent-race-2025-final_2/62.png" class="">

<p>那么这个 rdmsr 执行完成之后，也就成功进行了异或操作。</p>
<img src="/2026/01/24/tencent-race-2025-final_2/63.png" class="">

<p>这个算法也不难，还是 defs.h 直接抄就行。</p>
<p>最后总结一下 flag 的执行逻辑：</p>
<ul>
<li>输入的 flag 先用 VT 的 EPT hook 执行单字节加密。</li>
<li>输入的 key 根据起最高有效字节的位数对 flag 执行异或加密。</li>
<li>EPT hook 替换了一个页，使用 TEA 加密 flag。</li>
<li>通过 rdmsr 指令对上一步的密文进行又一次异或加密，异或的密文取决于 flag 的长度。</li>
<li>最后进行比较。</li>
</ul>
<h2 id="解密-flag"><a href="#解密-flag" class="headerlink" title="解密 flag"></a>解密 flag</h2><p>那么拿到比较的字节，先进行异或解密，然后 TEA 解密，再根据 key 异或解密最后爆破最开始的单字节加密即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Solve.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;defs.h&quot;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> EncText[] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="number">0xC3</span>, <span class="number">0x54</span>, <span class="number">0x93</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x7B</span>, <span class="number">0xFD</span>, <span class="number">0xB1</span>, <span class="number">0x55</span>, <span class="number">0x5B</span>,</span><br><span class="line">  <span class="number">0x20</span>, <span class="number">0x73</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x5C</span>, <span class="number">0xDE</span>, <span class="number">0x54</span>, <span class="number">0x99</span>, <span class="number">0xEF</span>, <span class="number">0xA4</span>,</span><br><span class="line">  <span class="number">0xD4</span>, <span class="number">0x51</span>, <span class="number">0x76</span>, <span class="number">0xA9</span>, <span class="number">0x6A</span>, <span class="number">0x6B</span>, <span class="number">0xBA</span>, <span class="number">0xEF</span>, <span class="number">0xDE</span>, <span class="number">0x21</span>,</span><br><span class="line">  <span class="number">0xE2</span>, <span class="number">0xC6</span>, <span class="number">0xFE</span>, <span class="number">0x42</span>, <span class="number">0xA3</span>, <span class="number">0x8F</span>, <span class="number">0xBE</span>, <span class="number">0x63</span>, <span class="number">0x1C</span>, <span class="number">0x4C</span>,</span><br><span class="line">  <span class="number">0xC6</span>, <span class="number">0xE4</span>, <span class="number">0xAE</span>, <span class="number">0xD0</span>, <span class="number">0x4B</span>, <span class="number">0x3D</span>, <span class="number">0xF6</span>, <span class="number">0xC6</span>, <span class="number">0xDA</span>, <span class="number">0xEB</span>,</span><br><span class="line">  <span class="number">0x07</span>, <span class="number">0x38</span>, <span class="number">0x14</span>, <span class="number">0x58</span>, <span class="number">0xDF</span>, <span class="number">0x2A</span>, <span class="number">0x2E</span>, <span class="number">0xC4</span>, <span class="number">0x83</span>, <span class="number">0x7A</span>,</span><br><span class="line">  <span class="number">0x33</span>, <span class="number">0x8D</span>, <span class="number">0x34</span>, <span class="number">0x9E</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0x27</span>, <span class="number">0x78</span>, <span class="number">0xC0</span>, <span class="number">0x5F</span>,</span><br><span class="line">  <span class="number">0xA5</span>, <span class="number">0xC4</span>, <span class="number">0xD0</span>, <span class="number">0x64</span>, <span class="number">0x0B</span>, <span class="number">0xDC</span>, <span class="number">0x5D</span>, <span class="number">0x6C</span>, <span class="number">0xE3</span>, <span class="number">0x7E</span>,</span><br><span class="line">  <span class="number">0x2C</span>, <span class="number">0xE4</span>, <span class="number">0x3B</span>, <span class="number">0xE4</span>, <span class="number">0xCA</span>, <span class="number">0x05</span>, <span class="number">0xE4</span>, <span class="number">0xD5</span>, <span class="number">0xA7</span>, <span class="number">0xC9</span>,</span><br><span class="line">  <span class="number">0x72</span>, <span class="number">0xB7</span>, <span class="number">0xC7</span>, <span class="number">0xCD</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x1C</span>, <span class="number">0xB3</span>, <span class="number">0x09</span>, <span class="number">0x2F</span>,</span><br><span class="line">  <span class="number">0xD7</span>, <span class="number">0x9D</span>, <span class="number">0x83</span>, <span class="number">0xFA</span>, <span class="number">0x88</span>, <span class="number">0x7B</span>, <span class="number">0x54</span>, <span class="number">0x57</span>, <span class="number">0xAE</span>, <span class="number">0xB5</span>,</span><br><span class="line">  <span class="number">0x54</span>, <span class="number">0xF7</span>, <span class="number">0x75</span>, <span class="number">0x7B</span>, <span class="number">0x1F</span>, <span class="number">0x23</span>, <span class="number">0x70</span>, <span class="number">0x07</span>, <span class="number">0x16</span>, <span class="number">0x13</span>,</span><br><span class="line">  <span class="number">0x79</span>, <span class="number">0x15</span>, <span class="number">0xB7</span>, <span class="number">0x6E</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0xA2</span>, <span class="number">0x0F</span>, <span class="number">0x90</span>, <span class="number">0xE8</span>,</span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0x61</span>, <span class="number">0x1D</span>, <span class="number">0x4E</span>, <span class="number">0x60</span>, <span class="number">0xEF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> flag_len = <span class="number">34</span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> __fastcall <span class="title">doenc</span><span class="params">(<span class="type">char</span> chr, <span class="type">char</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> v2; <span class="comment">// r10</span></span><br><span class="line">	<span class="type">bool</span> v3; <span class="comment">// zf</span></span><br><span class="line">	<span class="type">unsigned</span> __int8 xorvalue; <span class="comment">// r11</span></span><br><span class="line">	<span class="type">unsigned</span> __int8 acc; <span class="comment">// dl</span></span><br><span class="line">	<span class="type">unsigned</span> __int8 v6; <span class="comment">// cl</span></span><br><span class="line">	__int64 v7; <span class="comment">// rbx</span></span><br><span class="line">	__int64 onecount; <span class="comment">// rcx</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> j; <span class="comment">// edi</span></span><br><span class="line">	<span class="type">char</span> v10; <span class="comment">// r9</span></span><br><span class="line">	__int64 v11; <span class="comment">// rdx</span></span><br><span class="line">	<span class="type">int</span> i; <span class="comment">// eax</span></span><br><span class="line">	_BYTE* v13; <span class="comment">// r8</span></span><br><span class="line">	<span class="type">char</span> v14; <span class="comment">// dl</span></span><br><span class="line">	<span class="type">char</span> v15; <span class="comment">// dl</span></span><br><span class="line">	_BYTE v17[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">	v2 = <span class="number">0</span>;</span><br><span class="line">	xorvalue = idx ^ chr;</span><br><span class="line">	v3 = idx == chr;</span><br><span class="line">	acc = <span class="number">0</span>;                                      <span class="comment">// account number of 1 bit</span></span><br><span class="line">	v6 = xorvalue;</span><br><span class="line">	<span class="keyword">if</span> (!v3)                                    <span class="comment">// if char != idx enter</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			acc += v6 &amp; <span class="number">1</span>;</span><br><span class="line">			v6 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">while</span> (v6);</span><br><span class="line">	&#125;</span><br><span class="line">	v7 = <span class="number">7</span>;</span><br><span class="line">	onecount = acc;</span><br><span class="line">	*(_DWORD*)v17 = <span class="number">0x3020100</span>;</span><br><span class="line">	*(_DWORD*)&amp;v17[<span class="number">4</span>] = <span class="number">0x7060504</span>;</span><br><span class="line">	j = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		v10 = v17[v7];</span><br><span class="line">		onecount = <span class="number">0x3F5713FCCC7C79AALL</span> * onecount + <span class="number">0x3A7D9E5B36F498B2LL</span>;</span><br><span class="line">		v11 = <span class="built_in">HIDWORD</span>(onecount) % j--;              <span class="comment">// random value</span></span><br><span class="line">		v17[v7--] = v17[v11];</span><br><span class="line">		v17[v11] = v10;</span><br><span class="line">	&#125; <span class="keyword">while</span> (v7 &gt; <span class="number">0</span>);</span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	v13 = v17;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		v14 = xorvalue &gt;&gt; *v13++;</span><br><span class="line">		v15 = (v14 &amp; <span class="number">1</span>) &lt;&lt; i++;</span><br><span class="line">		v2 |= v15;</span><br><span class="line">	&#125; <span class="keyword">while</span> (i &lt; <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> xorkey[] = &#123;</span><br><span class="line">	<span class="number">0xd2</span>, <span class="number">0x5f</span>, <span class="number">0x26</span>, <span class="number">0x11</span>, <span class="number">0x67</span>, <span class="number">0x06</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">XorEnc</span><span class="params">(<span class="type">char</span>* input, <span class="type">int</span> len)</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; flag_len; i++) &#123;</span><br><span class="line">		input[i] = input[i] ^ xorkey[i % <span class="number">6</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LastXorEnc</span><span class="params">(<span class="type">char</span>* input, <span class="type">int</span> len)</span> </span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// esi</span></span><br><span class="line">	<span class="type">char</span>* v8; <span class="comment">// r11</span></span><br><span class="line">	<span class="type">unsigned</span> __int64 v9; <span class="comment">// r10</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// r14d</span></span><br><span class="line">	<span class="type">unsigned</span> __int64 j; <span class="comment">// rdi</span></span><br><span class="line">	<span class="type">char</span> v12; <span class="comment">// al</span></span><br><span class="line">	<span class="type">unsigned</span> __int64 v13; <span class="comment">// rax</span></span><br><span class="line">	_BYTE v18[<span class="number">24</span>]; <span class="comment">// [rsp+28h] [rbp-38h] BYREF</span></span><br><span class="line">	<span class="type">char</span> v19[<span class="number">5</span>]; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">	<span class="type">char</span> v20[<span class="number">7</span>]; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">	*(_DWORD*)v19 = <span class="number">315469193</span>;</span><br><span class="line">	v19[<span class="number">4</span>] = <span class="number">86</span>;</span><br><span class="line">	*(_DWORD*)v20 = <span class="number">-279418536</span>;</span><br><span class="line">	*(_WORD*)&amp;v20[<span class="number">4</span>] = <span class="number">18099</span>;</span><br><span class="line">	v20[<span class="number">6</span>] = <span class="number">35</span>;</span><br><span class="line">	v7 = len;</span><br><span class="line">	v8 = input;</span><br><span class="line">	<span class="keyword">if</span> (v7)</span><br><span class="line">	&#123;</span><br><span class="line">		v9 = (((<span class="type">unsigned</span> __int64)v7 - <span class="number">1</span>) &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>;<span class="comment">// 计算向上整除结果</span></span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			i = <span class="number">0</span>;</span><br><span class="line">			j = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">do</span>                                  <span class="comment">// 每8字节为一组循环</span></span><br><span class="line">			&#123;</span><br><span class="line">				v12 = i++ + v7 + v19[j % <span class="number">5</span>] + v20[j % <span class="number">7</span>];</span><br><span class="line">				v8[j++] ^= v12;</span><br><span class="line">			&#125; <span class="keyword">while</span> (i &lt; <span class="number">8</span>);</span><br><span class="line">			v8 += <span class="number">8</span>;</span><br><span class="line">			--v9;</span><br><span class="line">		&#125; <span class="keyword">while</span> (v9);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">TEA_Enc</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span>* a1, __int32* a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> v3; <span class="comment">// [rsp+0h] [rbp-58h]</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+4h] [rbp-54h]</span></span><br><span class="line">	<span class="type">unsigned</span> __int32 v5; <span class="comment">// [rsp+8h] [rbp-50h]</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> rounds; <span class="comment">// [rsp+Ch] [rbp-4Ch]</span></span><br><span class="line"></span><br><span class="line">	v3 = <span class="number">0</span>;</span><br><span class="line">	rounds = <span class="number">0</span>;</span><br><span class="line">	v4 = *a1;</span><br><span class="line">	v5 = a1[<span class="number">1</span>];</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		v4 += (v3 + a2[v3 &amp; <span class="number">3</span>]) ^ (v5 + ((v5 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * v5)));</span><br><span class="line">		v3 -= <span class="number">0x788EEF63</span>;</span><br><span class="line">		v5 = v5 + <span class="number">0x7C77AF7C</span> + ((v3 + v4) ^ v4 ^ (a2[<span class="number">2</span>] + <span class="number">16</span> * v4) ^ (a2[<span class="number">3</span>] + (v4 &gt;&gt; <span class="number">5</span>)) ^ <span class="number">0x4321</span>) - <span class="number">0x5901181B</span>;</span><br><span class="line">		++rounds;</span><br><span class="line">	&#125; <span class="keyword">while</span> (rounds &lt; <span class="number">60</span>);</span><br><span class="line">	*a1 = v4;</span><br><span class="line">	a1[<span class="number">1</span>] = v5;</span><br><span class="line">	<span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">TEA_Dec</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span>* a1, __int32* a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> v4;   <span class="comment">// left</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> v5;   <span class="comment">// right</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> v3;   <span class="comment">// delta</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> rounds;</span><br><span class="line"></span><br><span class="line">	v4 = a1[<span class="number">0</span>];</span><br><span class="line">	v5 = a1[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// delta 初始化为加密结束态</span></span><br><span class="line">	v3 = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">-60</span> * <span class="number">0x788EEF63</span>);</span><br><span class="line"></span><br><span class="line">	rounds = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 1. 先逆 v5（因为加密里 v5 最后更新）</span></span><br><span class="line">		v5 = v5</span><br><span class="line">			- <span class="number">0x7C77AF7C</span></span><br><span class="line">			- ((v3 + v4)</span><br><span class="line">				^ v4</span><br><span class="line">				^ (a2[<span class="number">2</span>] + <span class="number">16</span> * v4)</span><br><span class="line">				^ (a2[<span class="number">3</span>] + (v4 &gt;&gt; <span class="number">5</span>))</span><br><span class="line">				^ <span class="number">0x4321</span>)</span><br><span class="line">			+ <span class="number">0x5901181B</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2. 逆 delta</span></span><br><span class="line">		v3 += <span class="number">0x788EEF63</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3. 再逆 v4</span></span><br><span class="line">		v4 -= (v3 + a2[v3 &amp; <span class="number">3</span>])</span><br><span class="line">			^ (v5 + ((v5 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * v5)));</span><br><span class="line"></span><br><span class="line">		++rounds;</span><br><span class="line">	&#125; <span class="keyword">while</span> (rounds &lt; <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">	a1[<span class="number">0</span>] = v4;</span><br><span class="line">	a1[<span class="number">1</span>] = v5;</span><br><span class="line">	<span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> TeaDecData[<span class="number">50</span>];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> key[<span class="number">4</span>]; <span class="comment">// [rsp+30h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">LastXorEnc</span>((<span class="type">char</span>*)EncText, flag_len);</span><br><span class="line"></span><br><span class="line">	key[<span class="number">0</span>] = <span class="number">0x89</span>;</span><br><span class="line">	key[<span class="number">1</span>] = <span class="number">0xFE</span>;</span><br><span class="line">	key[<span class="number">2</span>] = <span class="number">0x76</span>;</span><br><span class="line">	key[<span class="number">3</span>] = <span class="number">0xA0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; flag_len; i+=<span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">TEA_Dec</span>((<span class="type">unsigned</span> <span class="type">int</span>*)&amp;EncText[i * <span class="number">4</span>], (<span class="type">int</span> *)key);</span><br><span class="line">		<span class="keyword">if</span>(*(<span class="type">unsigned</span> <span class="type">int</span>*)&amp;EncText[i * <span class="number">4</span>] &gt;= <span class="number">0x100</span>)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Tea Decrypt Error!\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		TeaDecData[i] = EncText[i * <span class="number">4</span>];</span><br><span class="line">		TeaDecData[i + <span class="number">1</span>] = EncText[i * <span class="number">4</span> + <span class="number">4</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">XorEnc</span>((<span class="type">char</span>*)TeaDecData, flag_len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; flag_len; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">256</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">doenc</span>(j, i) == TeaDecData[i]) &#123;</span><br><span class="line">				<span class="built_in">putchar</span>(j);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ACE_C0n9raTs0nPA55TheZ02S9AmeScTf#</span></span><br></pre></td></tr></table></figure>

<p>那么到这里基本就接近分析的尾声了，最后一问思维比较发散，可以利用 VT 的各个特性甚至题目的特性去检验，就不再过多啰嗦了。</p>
<p>unicorn 模拟执行的相关代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> ida_ua</span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">exports = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GetNTExport</span>():</span><br><span class="line">    lines = <span class="built_in">open</span>(<span class="string">&quot;./ntExport.txt&quot;</span>).readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        items = line.strip().split()</span><br><span class="line">        exports[<span class="built_in">int</span>(items[<span class="number">2</span>], <span class="number">16</span>)] = items[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line"><span class="comment"># 配置区</span></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line">MAX_INSTR = <span class="number">500000</span></span><br><span class="line">PAGE_SIZE = <span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">fix_function_start = <span class="number">0xFFFFF8080AFC300C</span></span><br><span class="line">RSP = <span class="number">0x00000000DEAD0000</span></span><br><span class="line">RBP = <span class="number">0x00000000DEAD0000</span></span><br><span class="line"></span><br><span class="line">base_addr = idaapi.get_imagebase()</span><br><span class="line">GetNTExport()</span><br><span class="line"></span><br><span class="line">brk = <span class="number">0xc0de0000</span></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line"><span class="comment"># 工具函数</span></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">align_down</span>(<span class="params">x, a</span>):</span><br><span class="line">    <span class="keyword">return</span> x &amp; ~(a - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disasm</span>(<span class="params">ea</span>):</span><br><span class="line">    insn = ida_ua.insn_t()</span><br><span class="line">    <span class="keyword">if</span> ida_ua.decode_insn(insn, ea):</span><br><span class="line">        <span class="keyword">return</span> ida_ua.print_insn_mnem(ea) + <span class="string">&quot; &quot;</span> + ida_ua.print_operand(ea, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">AllocMemory</span>(<span class="params">uc</span>):</span><br><span class="line">    <span class="keyword">global</span> brk</span><br><span class="line">    addr = brk</span><br><span class="line">    brk += PAGE_SIZE</span><br><span class="line">    uc.mem_map(addr, PAGE_SIZE)</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line"><span class="comment"># Hook: 未映射内存</span></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_unmapped</span>(<span class="params">uc, access, address, size, value, user_data</span>):</span><br><span class="line">    page = align_down(address, PAGE_SIZE)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        uc.mem_map(page, PAGE_SIZE)</span><br><span class="line">        data = ida_bytes.get_bytes(page, PAGE_SIZE)</span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b&#x27;\xff&#x27;</span> * PAGE_SIZE:</span><br><span class="line">            <span class="comment"># print(&quot;Out of bound!&quot;)</span></span><br><span class="line">            data = <span class="string">b&#x27;\xC3&#x27;</span> * PAGE_SIZE</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            uc.mem_write(page, data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            uc.mem_write(page, <span class="string">b&quot;\xC3&quot;</span> * PAGE_SIZE)</span><br><span class="line">        <span class="comment"># print(f&quot;[+] mapped data &#123;data&#125;&quot;)</span></span><br><span class="line">        <span class="comment"># print(f&quot;[+] mapped page @ &#123;hex(page)&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] map failed @ <span class="subst">&#123;<span class="built_in">hex</span>(page)&#125;</span> : <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line"><span class="comment"># Hook: 指令执行</span></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line">instr_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_UnicodeString</span>(<span class="params">uc, address</span>):</span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">bytes</span> = <span class="string">b&#x27;\xFF\xFF&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">bytes</span> != <span class="string">b&#x27;\x00\x00&#x27;</span>:</span><br><span class="line">        <span class="built_in">bytes</span> = uc.mem_read(address, <span class="number">2</span>)</span><br><span class="line">        s += <span class="built_in">chr</span>(<span class="built_in">bytes</span>[<span class="number">0</span>])</span><br><span class="line">        address += <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_String</span>(<span class="params">uc, address</span>):</span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">bytes</span> = <span class="string">b&#x27;\xFF&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">bytes</span> != <span class="string">b&#x27;\x00&#x27;</span>:</span><br><span class="line">        <span class="built_in">bytes</span> = uc.mem_read(address, <span class="number">1</span>)</span><br><span class="line">        s += <span class="built_in">chr</span>(<span class="built_in">bytes</span>[<span class="number">0</span>])</span><br><span class="line">        address += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">    <span class="keyword">global</span> instr_count</span><br><span class="line">    instr_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    rip = uc.reg_read(UC_X86_REG_RIP)</span><br><span class="line">    rsp = uc.reg_read(UC_X86_REG_RSP)</span><br><span class="line">    rcx = uc.reg_read(UC_X86_REG_RCX)</span><br><span class="line">    rdx = uc.reg_read(UC_X86_REG_RDX)</span><br><span class="line">    r8 = uc.reg_read(UC_X86_REG_R8)</span><br><span class="line">    r9 = uc.reg_read(UC_X86_REG_R9)</span><br><span class="line">    <span class="keyword">if</span> rip <span class="keyword">in</span> exports:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Try to execute nt!<span class="subst">&#123;exports[rip]&#125;</span>&quot;</span>)</span><br><span class="line">        uc.reg_write(UC_X86_REG_RAX, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> exports[rip] == <span class="string">&#x27;RtlInitUnicodeString&#x27;</span>:</span><br><span class="line">            s = read_UnicodeString(uc, rdx)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;str &quot;</span>, s)</span><br><span class="line">        <span class="keyword">elif</span> exports[rip] == <span class="string">&#x27;ExAllocatePoolWithTag&#x27;</span>:</span><br><span class="line">            addr = AllocMemory(uc)</span><br><span class="line">            uc.reg_write(UC_X86_REG_RAX, addr)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Allocate Memory @ &quot;</span>, <span class="built_in">hex</span>(addr))</span><br><span class="line">        <span class="keyword">elif</span> exports[rip] == <span class="string">&#x27;DbgPrint&#x27;</span>:</span><br><span class="line">            s = read_String(uc, rcx)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">hex</span>(rcx))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;DbgPrint &quot;</span>, s)</span><br><span class="line">        <span class="comment"># emu ret</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        raw = idaapi.generate_disasm_line(rip, <span class="number">0</span>)</span><br><span class="line">        text = ida_lines.tag_remove(raw)</span><br><span class="line">        <span class="comment"># print(f&quot;[&#123;instr_count:05d&#125;] &#123;rip:016X&#125;  &#123;text&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">if</span> instr_count &gt;= MAX_INSTR:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] instruction limit reached, stopping emulation&quot;</span>)</span><br><span class="line">        uc.emu_stop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line"><span class="comment"># Unicorn 初始化</span></span><br><span class="line"><span class="comment"># ======================</span></span><br><span class="line">mu = Uc(UC_ARCH_X86, UC_MODE_64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 寄存器</span></span><br><span class="line">mu.reg_write(UC_X86_REG_RIP, fix_function_start)</span><br><span class="line">mu.reg_write(UC_X86_REG_RSP, RSP)</span><br><span class="line">mu.reg_write(UC_X86_REG_RBP, RBP)</span><br><span class="line">mu.reg_write(UC_X86_REG_RCX, <span class="number">0</span>) <span class="comment"># argument 1</span></span><br><span class="line">mu.reg_write(UC_X86_REG_RDX, <span class="number">0</span>) <span class="comment"># argument 2</span></span><br><span class="line"><span class="comment"># 栈</span></span><br><span class="line">mu.mem_map(RSP - PAGE_SIZE, PAGE_SIZE * <span class="number">2</span>)</span><br><span class="line"><span class="comment"># 堆</span></span><br><span class="line">mu.mem_map(<span class="number">0xc0de000</span>, PAGE_SIZE * <span class="number">2</span>)</span><br><span class="line"><span class="comment"># Hooks</span></span><br><span class="line">mu.hook_add(UC_HOOK_MEM_FETCH_UNMAPPED, hook_mem_unmapped)</span><br><span class="line">mu.hook_add(UC_HOOK_MEM_READ_UNMAPPED, hook_mem_unmapped)</span><br><span class="line">mu.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED, hook_mem_unmapped)</span><br><span class="line">mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] start RIP =&quot;</span>, <span class="built_in">hex</span>(fix_function_start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    mu.emu_start(fix_function_start, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] emu error:&quot;</span>, e)</span><br><span class="line">    rip = mu.reg_read(UC_X86_REG_RIP)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Last RIP=&quot;</span>, <span class="built_in">hex</span>(rip))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] RAX =&quot;</span>, <span class="built_in">hex</span>(mu.reg_read(UC_X86_REG_RAX)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] finished, total instr =&quot;</span>, instr_count)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>重新温习一遍去年的题目才发现这个题目蕴含了这么多的知识点，同时也发现自己上一次写的 wp 有多离谱，基本上就秉持着“暴力出奇迹”的原则，也是因为这样，当时比赛也只是获得了一个优秀奖，遂希望自己重振旗鼓，蓄势待发，争取今年能够获得更好的奖项。</p>
<p>关于本篇文章的视频讲解：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1fYzzB6Ede">https://www.bilibili.com/video/BV1fYzzB6Ede</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://xia0ji233.github.io">xia0ji233</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://xia0ji233.github.io/2026/01/24/tencent-race-2025-final_2/">https://xia0ji233.github.io/2026/01/24/tencent-race-2025-final_2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xia0ji233.github.io" target="_blank">xia0ji233's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/12/31/Summary2025/" title="2025年终总结"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2025年终总结</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><a href="/"> <div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div></a><div class="author-info__name">xia0ji233</div><div class="author-info__description">Nepnep team</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">313</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">93</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xia0ji233"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xia0ji233" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xia0ji233@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">老当益壮，宁移白首之心？穷且益坚，不坠青云之志。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">加载驱动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E9%A9%B1%E5%8A%A8"><span class="toc-number">3.</span> <span class="toc-text">调试驱动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%AE%97%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">优化算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8EFlag%E7%9A%84%E8%AE%A1%E7%AE%97%E6%B5%81%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">说明Flag的计算流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86-flag"><span class="toc-number">6.</span> <span class="toc-text">解密 flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">7.</span> <span class="toc-text">写在最后</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/24/tencent-race-2025-final_2/" title="腾讯游戏安全竞赛2025复赛题解（加强版）">腾讯游戏安全竞赛2025复赛题解（加强版）</a><time datetime="2026-01-24T04:00:00.000Z" title="发表于 2026-01-24 12:00:00">2026-01-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/31/Summary2025/" title="2025年终总结">2025年终总结</a><time datetime="2025-12-30T19:00:00.000Z" title="发表于 2025-12-31 03:00:00">2025-12-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/14/ARM1/" title="ARM汇编基础学习（1）">ARM汇编基础学习（1）</a><time datetime="2025-12-14T06:00:00.000Z" title="发表于 2025-12-14 14:00:00">2025-12-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/26/qwb2025_final/" title="强网杯S9决赛Pwn writeup">强网杯S9决赛Pwn writeup</a><time datetime="2025-11-26T15:00:00.000Z" title="发表于 2025-11-26 23:00:00">2025-11-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/16/Android1/" title="Android逆向学习（1）">Android逆向学习（1）</a><time datetime="2025-11-16T02:00:00.000Z" title="发表于 2025-11-16 10:00:00">2025-11-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2026 By xia0ji233</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">welcome to my blog</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><script src="/live2d-widget/dist/autoload.js"></script><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>